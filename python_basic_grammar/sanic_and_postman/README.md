# Sanic and Postman

Sanic æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå¼‚æ­¥ï¼ˆasynchronousï¼‰Webåº”ç”¨çš„Pythonæ¡†æ¶ï¼Œå®ƒåŸºäº Python 3.5+ å¼•å…¥çš„ `async/await` è¯­æ³•ï¼Œæ—¨åœ¨æä¾›é«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å’Œè·¯ç”±å¤„ç†åŠŸèƒ½ã€‚å®ƒçš„è®¾è®¡çµæ„Ÿæ¥è‡ªäº Flaskï¼Œä½†å¼ºè°ƒäº†å¼‚æ­¥å¤„ç†ï¼Œé€‚ç”¨äºé«˜å¹¶å‘çš„åº”ç”¨ã€‚<br>

- [Sanic and Postman](#sanic-and-postman)
  - [Sanicçš„å®‰è£…](#sanicçš„å®‰è£…)
  - [ç®€å•sanicåº”ç”¨ç¤ºä¾‹ï¼š](#ç®€å•sanicåº”ç”¨ç¤ºä¾‹)
  - [ä½¿ç”¨Postmanæµ‹è¯•Sanicå¯åŠ¨çš„æœåŠ¡ï¼š](#ä½¿ç”¨postmanæµ‹è¯•sanicå¯åŠ¨çš„æœåŠ¡)
    - [Postman ç®€ä»‹ï¼š](#postman-ç®€ä»‹)
    - [Postman æµ‹è¯• Sanic æœåŠ¡ï¼š](#postman-æµ‹è¯•-sanic-æœåŠ¡)
  - [GETå’ŒPOSTæ–¹æ³•ï¼š](#getå’Œpostæ–¹æ³•)
    - [GET æ–¹æ³•è¿›é˜¶ï¼š](#get-æ–¹æ³•è¿›é˜¶)
    - [POST æ–¹æ³•ï¼š](#post-æ–¹æ³•)
    - [POST æ–¹æ³•è·¯ç”±çš„æµ‹è¯•ï¼š](#post-æ–¹æ³•è·¯ç”±çš„æµ‹è¯•)
    - [Postman ä¸­ Body é€‰é¡¹çš„å«ä¹‰ä¸é€‰æ‹©ï¼š](#postman-ä¸­-body-é€‰é¡¹çš„å«ä¹‰ä¸é€‰æ‹©)
  - [request å¯¹è±¡ï¼š](#request-å¯¹è±¡)
    - [requestçš„å±æ€§:](#requestçš„å±æ€§)
    - [sanicä¸­çš„requestä»€ä¹ˆæ—¶å€™ç”¨:](#sanicä¸­çš„requestä»€ä¹ˆæ—¶å€™ç”¨)
    - [`request.json` ç”¨æ³•ç¤ºä¾‹:](#requestjson-ç”¨æ³•ç¤ºä¾‹)
  - [response å¯¹è±¡ï¼š](#response-å¯¹è±¡)
  - [é«˜çº§åŠŸèƒ½:](#é«˜çº§åŠŸèƒ½)
    - [åŸºäºç±»çš„è§†å›¾(Class Based Views)ï¼š](#åŸºäºç±»çš„è§†å›¾class-based-views)
      - [ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒä»¬(Why use them)ï¼Ÿ](#ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒä»¬why-use-them)
      - [é—®é¢˜æ‰€åœ¨(The problem)ï¼š](#é—®é¢˜æ‰€åœ¨the-problem)
      - [è§£å†³æ–¹æ¡ˆ(The solution)ï¼š](#è§£å†³æ–¹æ¡ˆthe-solution)
    - [Streaming:](#streaming)
      - [Response streaming:](#response-streaming)
  - [ä½¿ç”¨ Postman åŠ¨æ€æ›´æ–°SanicæœåŠ¡ä¸­ç±»å±æ€§ï¼š](#ä½¿ç”¨-postman-åŠ¨æ€æ›´æ–°sanicæœåŠ¡ä¸­ç±»å±æ€§)
    - [åœ¨ä¸»æ–‡ä»¶ä¸­å®šä¹‰è·¯ç”±ï¼š](#åœ¨ä¸»æ–‡ä»¶ä¸­å®šä¹‰è·¯ç”±)
    - [é™„å±æ–‡ä»¶ä¸­å®šä¹‰ç”¨æˆ·è¾“å‡ºçš„å¤„ç†æµç¨‹ï¼š](#é™„å±æ–‡ä»¶ä¸­å®šä¹‰ç”¨æˆ·è¾“å‡ºçš„å¤„ç†æµç¨‹)
    - [å·¥å…·å‹å‡½æ•°ä¸­å®šä¹‰æ–‡æœ¬å¤„ç†ã€å˜é‡æ›´æ–°ç»†èŠ‚ï¼š](#å·¥å…·å‹å‡½æ•°ä¸­å®šä¹‰æ–‡æœ¬å¤„ç†å˜é‡æ›´æ–°ç»†èŠ‚)
    - [è¿è¡Œæ–¹å¼ï¼š](#è¿è¡Œæ–¹å¼)
  - [ä½¿ç”¨Postman+globalåŠ¨æ€æ›´æ–°SanicæœåŠ¡ä¸­çš„æ•°æ®ï¼š](#ä½¿ç”¨postmanglobalåŠ¨æ€æ›´æ–°sanicæœåŠ¡ä¸­çš„æ•°æ®)
    - [ä»»åŠ¡ç›®æ ‡ï¼š](#ä»»åŠ¡ç›®æ ‡)
    - [ä¸»æ–‡ä»¶ï¼š](#ä¸»æ–‡ä»¶)
    - [å·¥å…·æ–‡ä»¶ï¼š](#å·¥å…·æ–‡ä»¶)
    - [æ•°æ®å­˜å…¥redisçš„æ–‡ä»¶ï¼š](#æ•°æ®å­˜å…¥redisçš„æ–‡ä»¶)
    - [æ¸…ç©ºRedisæ•°æ®(å¯é€‰)ï¼š](#æ¸…ç©ºredisæ•°æ®å¯é€‰)
    - [æ–‡ä»¶è¿è¡Œé¡ºåºï¼š](#æ–‡ä»¶è¿è¡Œé¡ºåº)
    - [ä»£ç è§£é‡Šï¼š](#ä»£ç è§£é‡Š)
  - [å¯åŠ¨SanicæœåŠ¡æ—¶åªåŠ è½½ä¸€æ¬¡æ¨¡å‹--é¿å…æ¯æ¬¡è°ƒç”¨æ¥å£æ—¶åŠ è½½æ¨¡å‹çš„è€—æ—¶:](#å¯åŠ¨sanicæœåŠ¡æ—¶åªåŠ è½½ä¸€æ¬¡æ¨¡å‹--é¿å…æ¯æ¬¡è°ƒç”¨æ¥å£æ—¶åŠ è½½æ¨¡å‹çš„è€—æ—¶)
    - [æ¨¡æ‹Ÿåœºæ™¯:](#æ¨¡æ‹Ÿåœºæ™¯)
    - [è§£å†³æ–¹æ¡ˆ-sanicåº”ç”¨çš„ä¸Šä¸‹æ–‡:](#è§£å†³æ–¹æ¡ˆ-sanicåº”ç”¨çš„ä¸Šä¸‹æ–‡)
    - [è§£å†³æ–¹æ¡ˆ-å…¨å±€å˜é‡:](#è§£å†³æ–¹æ¡ˆ-å…¨å±€å˜é‡)
    - [åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†`app.ctx`å†™æ³•å’Œå…¨å±€å˜é‡å†™æ³•çš„åŒºåˆ«:](#åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†appctxå†™æ³•å’Œå…¨å±€å˜é‡å†™æ³•çš„åŒºåˆ«)
      - [åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç† (`app.ctx.classify_model = Classify_data()`):](#åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†-appctxclassify_model--classify_data)
      - [å…¨å±€å®ä¾‹åŒ– (`classify_model = Classify_data()`):](#å…¨å±€å®ä¾‹åŒ–-classify_model--classify_data)
      - [é€‰æ‹©ä¾æ®:](#é€‰æ‹©ä¾æ®)
  - [Sanic Blueprint:](#sanic-blueprint)
    - [å®Œæ•´ä»£ç --å•ä¸ªè“å›¾ï¼š](#å®Œæ•´ä»£ç --å•ä¸ªè“å›¾)
    - [å®Œæ•´ä»£ç --å¤šä¸ªè“å›¾ï¼š](#å®Œæ•´ä»£ç --å¤šä¸ªè“å›¾)
  - [ä½¿ç”¨Sanicå®ç°Server Sent Event(SSE):](#ä½¿ç”¨sanicå®ç°server-sent-eventsse)
    - [`index.html`æ–‡ä»¶ä»£ç å¦‚ä¸‹:](#indexhtmlæ–‡ä»¶ä»£ç å¦‚ä¸‹)
    - [`server.py`æ–‡ä»¶ä»£ç å¦‚ä¸‹:](#serverpyæ–‡ä»¶ä»£ç å¦‚ä¸‹)
    - [POSTæ–¹å¼è¿›è¡ŒSSEä¼ è¾“:](#postæ–¹å¼è¿›è¡Œsseä¼ è¾“)
    - [ç»“åˆLLM APIçš„SSEç¤ºä¾‹:](#ç»“åˆllm-apiçš„sseç¤ºä¾‹)
  - [åˆ©ç”¨Chromeæµè§ˆå™¨ä»¥éåŸŸåçš„å½¢å¼è§£é™¤é™åˆ¶è®¿é—®è‡ªå·±çš„æœåŠ¡:](#åˆ©ç”¨chromeæµè§ˆå™¨ä»¥éåŸŸåçš„å½¢å¼è§£é™¤é™åˆ¶è®¿é—®è‡ªå·±çš„æœåŠ¡)
    - [æ–¹æ¡ˆä¸€: ä¸ºè‡ªå·±æœåŠ¡æ³¨å†Œ/ç»‘å®šä¸€ä¸ªåŸŸåã€‚](#æ–¹æ¡ˆä¸€-ä¸ºè‡ªå·±æœåŠ¡æ³¨å†Œç»‘å®šä¸€ä¸ªåŸŸå)
    - [æ–¹æ¡ˆäºŒ: æ›´æ”¹Chromeè¯•éªŒæ¨¡å¼é…ç½®ã€‚](#æ–¹æ¡ˆäºŒ-æ›´æ”¹chromeè¯•éªŒæ¨¡å¼é…ç½®)

## Sanicçš„å®‰è£…

pip å®‰è£…sanicçš„æŒ‡ä»¤å¦‚ä¸‹ï¼š<br>

```bash
pip install sanic
```

## ç®€å•sanicåº”ç”¨ç¤ºä¾‹ï¼š

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä»‹ç»ï¼Œè¯´æ˜å¦‚ä½•ä½¿ç”¨ Sanic æ„å»ºä¸€ä¸ªåŸºæœ¬çš„ Web åº”ç”¨ï¼š<br>

1. åˆ›å»ºä¸€ä¸ª Sanic åº”ç”¨:

åˆ›å»ºä¸€ä¸ª Python æ–‡ä»¶ï¼Œä¾‹å¦‚ `sanic_server.py`(æ–‡ä»¶åå¯ä»¥éšæ„å®šä¹‰)ï¼Œå¹¶å¯¼å…¥ Sanicï¼š<br>

```python
from sanic import Sanic
from sanic import response

app = Sanic(__name__)
```

2. æ·»åŠ è·¯ç”±å’Œè§†å›¾å‡½æ•°:

åœ¨ä½ çš„åº”ç”¨ä¸­ï¼Œä½ å¯ä»¥å®šä¹‰ä¸åŒçš„è·¯ç”±ï¼Œå¹¶ä¸ºæ¯ä¸ªè·¯ç”±å®šä¹‰è§†å›¾å‡½æ•°ã€‚ä¾‹å¦‚ï¼š<br>

> `async def index()`éƒ¨åˆ†è¢«ç§°ä¸ºè§†å›¾å‡½æ•°ã€‚

```python
@app.route("/")
async def index(request):
    return response.text("Hello, Sanic!")

@app.route("/user/<name>")
async def greet_user(request, name):
    return response.text(f"Hello, {name}!")
```

è¿™é‡Œï¼Œ`@app.route` è£…é¥°å™¨ç”¨äºæŒ‡å®šè·¯ç”±ï¼Œæ¥å— HTTP è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚<br>

1. å¯åŠ¨ Sanic åº”ç”¨:

åœ¨åº”ç”¨çš„æœ€åï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ä»¥è¿è¡Œ Sanic æœåŠ¡å™¨ï¼š<br>

```python
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
```

æ³¨æ„: è®¾å®šç«¯å£å‰ä¸€å®šè¦å…ˆçœ‹è¿™ä¸ªç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æŸ¥çœ‹ã€‚<br>

```bash
lsof -i :8000
```

2. è¿è¡Œåº”ç”¨:

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œä½ çš„åº”ç”¨ï¼š<br>

```bash
python sanic_server.py
```

ç°åœ¨ï¼Œä½ çš„ Sanic åº”ç”¨åº”è¯¥å·²ç»åœ¨æœ¬åœ°è¿è¡Œï¼Œå¹¶ç›‘å¬åœ¨ç«¯å£ 8000 ä¸Šã€‚<br>

è¿™åªæ˜¯ Sanic çš„åŸºæœ¬ç”¨æ³•ï¼Œå®ƒè¿˜æä¾›äº†è®¸å¤šå…¶ä»–åŠŸèƒ½ï¼Œå¦‚ä¸­é—´ä»¶æ”¯æŒã€å¼‚æ­¥è¯·æ±‚å¤„ç†ã€WebSocket æ”¯æŒç­‰ç­‰ï¼Œä»¥æ»¡è¶³ä¸åŒç±»å‹çš„ Web åº”ç”¨éœ€æ±‚ã€‚ä½ å¯ä»¥æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ä»¥æ·±å…¥äº†è§£æ›´å¤šä¿¡æ¯ï¼šhttps://sanicframework.org/<br>

## ä½¿ç”¨Postmanæµ‹è¯•Sanicå¯åŠ¨çš„æœåŠ¡ï¼š

### Postman ç®€ä»‹ï¼š

Postman æ˜¯ä¸€ç§æµè¡Œçš„åº”ç”¨ç¨‹åºï¼Œç”¨äºæµ‹è¯•å’Œè°ƒè¯•ç½‘ç»œ APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„ç•Œé¢ï¼Œå…è®¸å¼€å‘äººå‘˜è½»æ¾åœ°åˆ›å»ºã€å‘é€å’Œæ¥æ”¶ HTTP è¯·æ±‚ï¼Œä»¥æµ‹è¯• API çš„å„ç§ç«¯ç‚¹å’ŒåŠŸèƒ½ã€‚Postman è¿˜å…è®¸ä½ ç»„ç»‡è¯·æ±‚ã€ä¿å­˜å’Œåˆ†äº«æµ‹è¯•é›†åˆï¼Œä»¥åŠè‡ªåŠ¨åŒ– API æµ‹è¯•å·¥ä½œæµç¨‹ã€‚å®ƒå¯ç”¨äºå¤šç§ç”¨é€”ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•å’Œæ–‡æ¡£ç¼–åˆ¶ç­‰ã€‚<br>

å·¥ä½œä¸­ç»å¸¸ä½¿ç”¨ Postman æµ‹è¯• Sanic ç”¨äºæ„å»º Web åº”ç”¨ç¨‹åºå’Œ APIã€‚ä½¿ç”¨ Postman è¿›è¡Œå•ä¸ªæµ‹è¯•ï¼Œæˆ–è€…ä½¿ç”¨ Postman çš„è‡ªåŠ¨åŒ–åŠŸèƒ½æ¥åˆ›å»º API æ–‡æ¡£å’Œæµ‹è¯•é›†åˆã€‚è¿™æœ‰åŠ©äºç¡®ä¿ API çš„è´¨é‡å’Œæ€§èƒ½ã€‚<br>

Postman ä¸»ç•Œé¢ä»‹ç»å¦‚ä¸‹ï¼š<br>

![Postmanä¸»ç•Œé¢](./postmanä¸»ç•Œé¢æ ‡è¯†.png)

### Postman æµ‹è¯• Sanic æœåŠ¡ï¼š

ğŸ³ğŸ³ğŸ³ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ä»£ç (`sanic_server.py`)ä»‹ç»å¦‚ä½•ä½¿ç”¨ Postman æµ‹è¯•æˆ‘ä»¬æ‰€å¯åŠ¨çš„ Sanic æœåŠ¡æ•ˆæœå¦‚ä½•ã€‚<br>

```python
# sanic_server.py
from sanic import Sanic
from sanic import response

app = Sanic(__name__)

@app.route("/")
async def index(request):
    """è¯¥è·¯ç”±ä¸ºGETæ–¹æ³•
    postmané€‰æ‹©GETæ–¹æ³•ï¼Œåœ¨urlå¡«å…¥http://8.140.203.xxx:8848/çš„ç½‘å€ï¼Œç‚¹å‡»Sendå³å¯æŸ¥çœ‹æ•ˆæœã€‚(ä¸éœ€è¦é¢å¤–é€‰æ‹©å‚æ•°ã€‚)
    """
    return response.text("Hello, Sanic!")

@app.route("/user/<name>")
async def greet_user(request, name):
    """è¯¥è·¯ç”±ä¸ºGETæ–¹æ³•
    è¿™ä¸ªè·¯ç”±åŒ…å«äº†ä¸€ä¸ªåŠ¨æ€å‚æ•° `<name>`ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥åœ¨ URL ä¸­æ¥å—ç”¨æˆ·æä¾›çš„å€¼ã€‚ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·è®¿é—®ç±»ä¼¼ http://8.140.203.xxx:8848/user/John çš„URLæ—¶ï¼Œä¼šæ‰§è¡Œ `greet_user` å‡½æ•°ï¼Œå¹¶å°† `name` å‚æ•°è®¾ç½®ä¸º "John"ï¼Œç„¶åè¿”å› "Hello, John!" çš„æ–‡æœ¬å“åº”ã€‚
    """
    return response.text(f"Hello, {name}!")

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
```

è¦ä½¿ç”¨Postmanæµ‹è¯•ä¸Šè¿°Sanicåº”ç”¨ç¨‹åºï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š<br>

1. å¯åŠ¨Sanicåº”ç”¨ç¨‹åºï¼š
   
åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œä½ çš„Pythonè„šæœ¬ï¼Œä»¥å¯åŠ¨Sanicåº”ç”¨ç¨‹åºã€‚è¿™å°†ä½¿åº”ç”¨ç¨‹åºåœ¨æœ¬åœ°è¿è¡Œå¹¶ç›‘å¬ç«¯å£8000ã€‚<br>

```bash
python sanic_server.py
```

2. æ‰“å¼€Postmanï¼š
   
æ‰“å¼€Postmanåº”ç”¨ç¨‹åºæˆ–è®¿é—®Postmanç½‘ç«™ã€‚<br>

3. åˆ›å»ºä¸€ä¸ªæ–°çš„è¯·æ±‚ï¼š

åœ¨Postmanä¸»ç•Œé¢ä¸­ï¼Œç‚¹å‡»"New"ï¼ˆæ–°å»ºï¼‰æŒ‰é’®ï¼Œç„¶åé€‰æ‹©HTTPæ–¹æ³•ã€‚<br>

4. é…ç½®è¯·æ±‚ï¼š
   
- åœ¨è¯·æ±‚çš„"Request Type"ï¼ˆè¯·æ±‚ç±»å‹ï¼‰ä¸‹æ‹‰èœå•ä¸­ï¼Œé€‰æ‹©HTTPæ–¹æ³•ï¼Œå¦‚GETã€POSTç­‰ã€‚ä¸Šè¿°ä»£ç æˆ‘åªä½¿ç”¨äº†GETæ–¹æ³•çš„è·¯ç”±ï¼Œæ‰€ä»¥è¯·æ±‚ç±»å‹è®¾ç½®ä¸ºGETã€‚

- åœ¨"Enter request URL"ï¼ˆè¾“å…¥è¯·æ±‚URLï¼‰å­—æ®µä¸­ï¼Œè¾“å…¥Sanicåº”ç”¨ç¨‹åºçš„URLã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒåº”è¯¥æ˜¯`http://localhost:8000`ï¼Œä½†å¦‚æœä½ çš„åº”ç”¨ç¨‹åºåœ¨ä¸åŒçš„ä¸»æœºæˆ–ç«¯å£ä¸Šè¿è¡Œï¼Œè¯·ç›¸åº”åœ°æ›´æ”¹URLã€‚

- å¦‚æœä½ è¦æµ‹è¯•å…·æœ‰å‚æ•°çš„è·¯ç”±ï¼Œå¦‚`/user/<name>`ï¼Œåˆ™éœ€è¦åœ¨URLä¸­åŒ…å«ç›¸åº”çš„å‚æ•°ï¼Œä¾‹å¦‚`http://localhost:8000/user/John`ã€‚

- åœ¨"Headers"ï¼ˆæ ‡å¤´ï¼‰éƒ¨åˆ†ï¼Œä½ å¯ä»¥æ·»åŠ ä»»ä½•å¿…è¦çš„æ ‡å¤´ã€‚**é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ·»åŠ ä»»ä½•ç‰¹æ®Šæ ‡å¤´ã€‚**ğŸ˜€ğŸ˜€ğŸ˜€

- å¦‚æœä½ ä½¿ç”¨POSTè¯·æ±‚ï¼Œä½ å¯ä»¥åœ¨"Body"ï¼ˆæ­£æ–‡ï¼‰éƒ¨åˆ†è®¾ç½®è¯·æ±‚æ­£æ–‡ã€‚æ ¹æ®ä½ çš„åº”ç”¨ç¨‹åºï¼Œå¯èƒ½éœ€è¦åœ¨æ­£æ–‡ä¸­åŒ…å«JSONæ•°æ®æˆ–è¡¨å•æ•°æ®ã€‚

5. å‘é€è¯·æ±‚ï¼š

ç‚¹å‡»"Send"ï¼ˆå‘é€ï¼‰æŒ‰é’®ä»¥å‘é€è¯·æ±‚åˆ°Sanicåº”ç”¨ç¨‹åºã€‚<br>

6. æŸ¥çœ‹å“åº”ï¼š

Postmanå°†æ˜¾ç¤ºä»Sanicåº”ç”¨ç¨‹åºæ¥æ”¶åˆ°çš„å“åº”ã€‚ä½ åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ä½ çš„åº”ç”¨ç¨‹åºè¿”å›çš„æ•°æ®æˆ–æ¶ˆæ¯ã€‚<br>

é€šè¿‡æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤é…ç½®å’Œå‘é€è¯·æ±‚ï¼Œä½ å¯ä»¥ä½¿ç”¨Postmanæµ‹è¯•ä½ çš„Sanicåº”ç”¨ç¨‹åºçš„ä¸åŒè·¯ç”±å’ŒåŠŸèƒ½ã€‚ç¡®ä¿ä½ çš„Sanicåº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”Postmané…ç½®æ­£ç¡®ä»¥ä¾¿ä¸å…¶é€šä¿¡ã€‚<br>


## GETå’ŒPOSTæ–¹æ³•ï¼š

### GET æ–¹æ³•è¿›é˜¶ï¼š

ç¬”è€…åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­å®šä¹‰çš„ä¸¤ä¸ªè·¯ç”±é»˜è®¤éƒ½æ˜¯ä½¿ç”¨ GET æ–¹æ³•ã€‚GET æ–¹æ³•çš„ä½¿ç”¨è¾ƒä¸ºç®€å•ï¼Œä½†åœ¨ä½¿ç”¨ GET æ–¹æ³•æ—¶ä¾æ—§è¦æ³¨æ„ä¸€äº›å†…å®¹ï¼š<br>

GET æ–¹æ³•ä¸ä¸€å®šéœ€è¦ä¼ é€’å‚æ•°ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨URLä¸­åŒ…å«æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆquery stringï¼‰æ¥ä¼ é€’å‚æ•°ã€‚æŸ¥è¯¢å­—ç¬¦ä¸²æ˜¯URLä¸­çš„ä¸€éƒ¨åˆ†ï¼Œé€šå¸¸è·Ÿåœ¨é—®å·ï¼ˆ?ï¼‰ä¹‹åï¼Œå‚æ•°ä¹‹é—´ç”¨â€œ&â€ç¬¦å·åˆ†éš”ã€‚ä¾‹å¦‚ï¼š<br>

```log
http://example.com/resource?param1=value1&param2=value2
```

åœ¨è¿™ä¸ªURLä¸­ï¼Œ`param1` å’Œ `param2` æ˜¯ä¸¤ä¸ªGETè¯·æ±‚çš„å‚æ•°ï¼Œå®ƒä»¬çš„å€¼åˆ†åˆ«æ˜¯`value1`å’Œ`value2`ã€‚<br>

åœ¨Sanicä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨`request.args`æ¥è·å–URLä¸­çš„æŸ¥è¯¢å‚æ•°ã€‚ä¾‹å¦‚ï¼š<br>

```python
from sanic import Sanic
from sanic import response

app = Sanic(__name__)

@app.route("/example")
async def example(request):
    param1 = request.args.get("param1")
    param2 = request.args.get("param2")
    
    return response.text(f"param1: {param1}, param2: {param2}")

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
```

å½“ä½ è®¿é—® `http://localhost:8000/example?param1=value1&param2=value2` æ—¶ï¼ŒSanic å°†ä»æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­æå–å‚æ•°å€¼ï¼Œå¹¶å°†å®ƒä»¬ä¼ é€’ç»™è·¯ç”±å¤„ç†å‡½æ•°ã€‚ç„¶åï¼Œä½ å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨è¿™äº›å‚æ•°æ¥æ‰§è¡Œé€»è¾‘æ“ä½œã€‚<br>

æ€»ç»“ä¸€ä¸‹ï¼ŒGET æ–¹æ³•é€šå¸¸ç”¨äºä»æœåŠ¡å™¨è·å–æ•°æ®ï¼Œå‚æ•°å¯ä»¥é€šè¿‡æŸ¥è¯¢å­—ç¬¦ä¸²ä¼ é€’ç»™æœåŠ¡å™¨ï¼Œç„¶åæœåŠ¡å™¨å¯ä»¥è§£ææŸ¥è¯¢å­—ç¬¦ä¸²æ¥è·å–è¿™äº›å‚æ•°çš„å€¼ã€‚ Sanic çš„ `request.args` å¯ä»¥å¸®åŠ©ä½ åœ¨è·¯ç”±å¤„ç†å‡½æ•°ä¸­æ–¹ä¾¿åœ°è·å–è¿™äº›å‚æ•°ã€‚<br>

### POST æ–¹æ³•ï¼š

å¦‚æœä½ æƒ³è¦å®šä¹‰ä¸€ä¸ªä½¿ç”¨ POST æ–¹æ³•çš„è·¯ç”±ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ `methods` å‚æ•°æ¥æŒ‡å®šè¯·æ±‚æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br>

```python
from sanic import Sanic
from sanic import response
import jieba

app = Sanic(__name__)

# ä½¿ç”¨ GET æ–¹æ³•çš„è·¯ç”±
@app.route("/")
async def index(request):
    return response.text("Hello, Sanic!")

@app.route("/segment", methods=["POST"])
async def segment(request):
    """åˆ†è¯API"""
    text = request.json.get("text")
    if not text:
        return response.json({"error": "Missing 'text' parameter"}, status=400)

    result = jieba.lcut(text)
    return response.json({"åˆ†è¯ç»“æœä¸ºï¼š": result})

@app.route("/ans", methods=["POST"])
async def answer(request):
    # è·å–ç”¨æˆ·æ•°æ®
    text = request.form.get("usr_input")
    if not text:
        return response.json({"error": "Missing 'usr_input' parameter"}, status=400)

    result = jieba.lcut(text)
    return response.json({"ç”¨æˆ·æ•°æ®åˆ†è¯ç»“æœä¸ºï¼š": result})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

ğŸš€ğŸš€ğŸš€æ¥ä¸‹æ¥ï¼Œæˆ‘è®²è§£ä¸‹ä¸Šè¿°ä»£ç ä¸­è·¯ç”±"/segment"å’Œ"/ans"çš„ä¸åŒï¼Œä»¥åŠåº”è¯¥å¦‚ä½•ç”¨postmanæµ‹è¯•ï¼š<br>

1. **è·¯ç”±è·¯å¾„**ï¼š

- "/segment"è·¯ç”±ç”¨äºå¤„ç†POSTè¯·æ±‚ï¼Œå…¶è·¯å¾„ä¸º"/segment"ã€‚

- "/ans"è·¯ç”±ä¹Ÿç”¨äºå¤„ç†POSTè¯·æ±‚ï¼Œå…¶è·¯å¾„ä¸º"/ans"ã€‚

2. **è¯·æ±‚å‚æ•°çš„è·å–æ–¹å¼**ï¼š

- "/segment"è·¯ç”±ä½¿ç”¨`request.json.get("text")`æ¥è·å–è¯·æ±‚ä¸­çš„**JSONæ•°æ®**ï¼Œå¹¶æœŸæœ›æ•°æ®åŒ…å«ä¸€ä¸ªåä¸º"text"çš„å­—æ®µã€‚

- "/ans"è·¯ç”±ä½¿ç”¨`request.form.get("usr_input")`æ¥è·å–**è¡¨å•æ•°æ®**ï¼Œå¹¶æœŸæœ›æ•°æ®åŒ…å«ä¸€ä¸ªåä¸º"usr_input"çš„å­—æ®µã€‚

3. **å“åº”**ï¼š

- "/segment"è·¯ç”±è¿”å›ä¸€ä¸ªJSONå“åº”ï¼Œå…¶ä¸­åŒ…å«åˆ†è¯çš„ç»“æœã€‚

- "/ans"è·¯ç”±ä¹Ÿè¿”å›ä¸€ä¸ªJSONå“åº”ï¼Œå…¶ä¸­åŒ…å«åˆ†è¯çš„ç»“æœã€‚

### POST æ–¹æ³•è·¯ç”±çš„æµ‹è¯•ï¼š

è¦ä½¿ç”¨Postmanæµ‹è¯•"/segment"å’Œ"/ans"è¿™ä¸¤ä¸ªè·¯ç”±ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š<br>

1. æ‰“å¼€Postmanåº”ç”¨ç¨‹åºã€‚

2. åˆ›å»ºä¸€ä¸ªæ–°çš„è¯·æ±‚ã€‚

3. åœ¨è¯·æ±‚çš„URLæ ä¸­è¾“å…¥ä½ çš„åº”ç”¨ç¨‹åºçš„åœ°å€å’Œç«¯å£ï¼Œä¾‹å¦‚ï¼šhttp://localhost:8848ã€‚

4. é€‰æ‹©HTTPæ–¹æ³•ä¸º"POST"ã€‚

5. å¯¹äº"/segment"è·¯ç”±ï¼Œåˆ‡æ¢åˆ°"Body"é€‰é¡¹å¡ï¼Œé€‰æ‹©"raw"ï¼Œç„¶ååœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥JSONæ•°æ®(**"raw"é€‰é¡¹çš„æœ€åä¸€ä½å¸¦ç®­å¤´ä½ç½®é€‰JSON**)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```json
{
    "text": "è¿™æ˜¯ä¸€æ®µæ–‡æœ¬ï¼Œéœ€è¦è¿›è¡Œåˆ†è¯ã€‚"
}
```

6. ç‚¹å‡»å‘é€æŒ‰é’®ï¼Œä½ å°†è·å¾—åˆ†è¯ç»“æœçš„JSONå“åº”ã€‚

7. å¯¹äº"/ans"è·¯ç”±ï¼Œåˆ‡æ¢åˆ°"Body"é€‰é¡¹å¡ï¼Œé€‰æ‹©"x-www-form-urlencoded"ï¼Œç„¶ååœ¨"Key"ä¸­æ·»åŠ ä¸€ä¸ªåä¸º"usr_input"çš„å­—æ®µï¼Œå¹¶åœ¨Valueä¸­è¾“å…¥æ–‡æœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```log
usr_input: è¿™æ˜¯ä¸€æ®µç”¨æˆ·æ•°æ®ï¼Œéœ€è¦è¿›è¡Œåˆ†è¯ã€‚
```

8. ç‚¹å‡»å‘é€æŒ‰é’®ï¼Œä½ å°†è·å¾—ç”¨æˆ·æ•°æ®åˆ†è¯ç»“æœçš„JSONå“åº”ã€‚

è¿™æ ·ï¼Œä½ å¯ä»¥ä½¿ç”¨Postmanæµ‹è¯•è¿™ä¸¤ä¸ªä¸åŒçš„è·¯ç”±å¹¶æŸ¥çœ‹å®ƒä»¬çš„ä¸åŒåŠŸèƒ½ã€‚ä¸€ä¸ªè·¯ç”±æœŸæœ›JSONæ•°æ®ï¼Œè€Œå¦ä¸€ä¸ªæœŸæœ›è¡¨å•æ•°æ®ã€‚<br>

### Postman ä¸­ Body é€‰é¡¹çš„å«ä¹‰ä¸é€‰æ‹©ï¼š
åœ¨Postmanä¸­ï¼ŒBodyé€‰é¡¹ç”¨äºæŒ‡å®šè¯·æ±‚çš„æ¶ˆæ¯ä½“ï¼ˆpayloadï¼‰å†…å®¹ã€‚ä»¥ä¸‹æ˜¯åœ¨Bodyé€‰é¡¹ä¸­å¸¸è§çš„å‡ ä¸ªé€‰é¡¹åŠå…¶å«ä¹‰ï¼š<br>

1. **none:** è¿™è¡¨ç¤ºè¯·æ±‚ä¸åŒ…å«æ¶ˆæ¯ä½“ã€‚é€‰æ‹©æ­¤é€‰é¡¹æ—¶ï¼Œè¯·æ±‚é€šå¸¸æ˜¯GETæˆ–DELETEç­‰ä¸éœ€è¦å‘é€æ•°æ®çš„HTTPæ–¹æ³•ã€‚

2. **form-Data:** å½“ä½¿ç”¨è¯¥é€‰é¡¹æ—¶ï¼Œè¯·æ±‚çš„æ¶ˆæ¯ä½“å°†è¢«æ ¼å¼åŒ–ä¸ºmultipart/form-dataæ ¼å¼ã€‚è¿™é€šå¸¸ç”¨äºä¸Šä¼ æ–‡ä»¶æˆ–é€šè¿‡è¡¨å•æäº¤æ•°æ®ã€‚

3. **x-www-form-urlencoded:** é€‰æ‹©æ­¤é€‰é¡¹å°†ä»¥URLç¼–ç å½¢å¼å‘é€è¯·æ±‚çš„æ•°æ®ã€‚ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥è¿™ç§æ ¼å¼é€šå¸¸ç”¨äºHTMLè¡¨å•æäº¤ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ã€‚

4. **raw:** å½“é€‰æ‹©æ­¤é€‰é¡¹æ—¶ï¼Œä½ å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘è¯·æ±‚çš„æ¶ˆæ¯ä½“å†…å®¹ã€‚ä½ å¯ä»¥é€‰æ‹©ä¸åŒçš„æ ¼å¼ï¼Œä¾‹å¦‚æ–‡æœ¬ï¼ˆçº¯æ–‡æœ¬ï¼‰ã€JSONï¼ˆåº”ç”¨/JSONï¼‰ã€XMLï¼ˆapplication/xmlï¼‰ç­‰ã€‚

5. **binary:** é€‰æ‹©æ­¤é€‰é¡¹ä»¥ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ä½ å¯ä»¥é€‰æ‹©å°†æ–‡ä»¶ç›´æ¥ä»ç£ç›˜ä¸Šè½½ï¼Œæˆ–è€…ä½¿ç”¨ä»£ç æˆ–å…¶ä»–æ–¹å¼ç”ŸæˆäºŒè¿›åˆ¶æ•°æ®ã€‚

6. **graphQL:** å¦‚æœä½ æ­£åœ¨ä½¿ç”¨GraphQL APIï¼Œåˆ™å¯ä»¥é€‰æ‹©æ­¤é€‰é¡¹ï¼Œå¹¶åœ¨è¯·æ±‚çš„æ¶ˆæ¯ä½“ä¸­ç¼–å†™GraphQLæŸ¥è¯¢ã€‚

7. **file:** è¿™ä¸ªé€‰é¡¹å…è®¸ä½ å°†æ–‡ä»¶ç›´æ¥ä½œä¸ºè¯·æ±‚çš„æ¶ˆæ¯ä½“ã€‚ä½ å¯ä»¥é€‰æ‹©ä»ç£ç›˜ä¸Šè½½æ–‡ä»¶ï¼Œæˆ–è€…ä»å·²å‘é€çš„è¯·æ±‚ä¸­é€‰æ‹©æ–‡ä»¶ã€‚

é€‰æ‹©å“ªä¸ªé€‰é¡¹å–å†³äºä½ è¦å‘é€çš„æ•°æ®ç±»å‹å’Œè¯·æ±‚çš„è¦æ±‚ã€‚å¦‚æœä½ è¦å‘é€è¡¨å•æ•°æ®ï¼Œä½ å¯ä»¥é€‰æ‹©Form-Dataæˆ–x-www-form-urlencodedã€‚å¦‚æœä½ è¦å‘é€JSONæ•°æ®ï¼Œå¯ä»¥é€‰æ‹©Rawå¹¶å°†Content-Typeè®¾ç½®ä¸ºapplication/jsonã€‚å¦‚æœä½ è¦ä¸Šä¼ æ–‡ä»¶ï¼Œä½ å¯ä»¥é€‰æ‹©Form-Dataæˆ–Binaryï¼Œå…·ä½“å–å†³äºä½ çš„éœ€æ±‚ã€‚<br>

## request å¯¹è±¡ï¼š

### requestçš„å±æ€§:

**request**åŒ…å«äº†å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å‘è¿‡æ¥çš„HTTPè¯·æ±‚çš„å„ç±»æ•°æ®ã€‚requestä¸éœ€è¦æ˜¾ç¤ºå¯¼å…¥ï¼ŒSanicå†…éƒ¨å«æœ‰ã€‚request åŒ…å«ä»¥ä¸‹å±æ€§ï¼š<br>

| å±æ€§   | ä½¿ç”¨æ–¹å¼        | æ„ä¹‰                                        |
|--------|-----------------|---------------------------------------------|
| json   | request.json | å½“å®¢æˆ·ç«¯POSTæ¥çš„æ•°æ®æ˜¯jsonæ ¼å¼æ—¶ï¼Œè®¿é—®jsonæ•°æ® |
| args   | request.args | æŸ¥è¯¢å­—ç¬¦ä¸²å˜é‡ï¼Œå³URLä¸­é—®å·?åé¢çš„éƒ¨åˆ†        |
| files  | å­—å…¸            | æ‹¥æœ‰nameã€bodyå’Œtypeçš„æ–‡ä»¶å¯¹è±¡çš„å­—å…¸           |
| form   | è¡¨å•            | ä»¥POSTæ–¹å¼ä¼ é€’çš„formå˜é‡                     |
| body   | å­—èŠ‚ä¸²          | POSTçš„åŸå§‹æ•°æ®                               |  


### sanicä¸­çš„requestä»€ä¹ˆæ—¶å€™ç”¨:

åœ¨ Sanic è¿™ä¸ªå¼‚æ­¥ Web æ¡†æ¶ä¸­ï¼Œ`request` å¯¹è±¡æ˜¯åœ¨å¤„ç†ä¼ å…¥çš„ HTTP è¯·æ±‚æ—¶ä½¿ç”¨çš„ã€‚å½“ä¸€ä¸ªè¯·æ±‚å‘é€åˆ°ä½ çš„ Sanic æœåŠ¡å™¨æ—¶ï¼ŒSanic ä¼šåˆ›å»ºä¸€ä¸ª `request` å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†è¿™ä¸ªè¯·æ±‚çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¯·æ±‚çš„ URLã€HTTP æ–¹æ³•ã€å¤´ä¿¡æ¯ã€æŸ¥è¯¢å‚æ•°ã€è¡¨å•æ•°æ®ã€JSON æ•°æ®ç­‰ã€‚<br>

ç®€å•æ¥è¯´ï¼Œæ¯å½“ä½ çš„æœåŠ¡å™¨æ”¶åˆ°ä¸€ä¸ª HTTP è¯·æ±‚ï¼ˆæ— è®ºæ˜¯ GET è¯·æ±‚ã€POST è¯·æ±‚ã€è¿˜æ˜¯å…¶ä»–ç±»å‹çš„è¯·æ±‚ï¼‰ï¼ŒSanic éƒ½ä¼šä¸ºè¿™ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ª `request` å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚åœ¨è¿™ä¸ªå¤„ç†å‡½æ•°ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ `request` å¯¹è±¡è®¿é—®è¯·æ±‚çš„æ‰€æœ‰ä¿¡æ¯ã€‚<br>

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Sanic ä¸­ä½¿ç”¨ `request` å¯¹è±¡ï¼š<br>

```python
from sanic import Sanic
from sanic.response import json

app = Sanic("MyApp")

@app.route("/get_data", methods=["GET"])
async def get_data(request):
    # ä½¿ç”¨ request.args è·å– URL æŸ¥è¯¢å‚æ•°
    query_params = request.args

    # ä½ å¯ä»¥è¿›ä¸€æ­¥å¤„ç†è¿™äº›å‚æ•°
    # ...

    return json({"message": "æ”¶åˆ° GET è¯·æ±‚", "query_params": query_params})

@app.route("/post_data", methods=["POST"])
async def post_data(request):
    # ä½¿ç”¨ request.json è·å– JSON æ ¼å¼çš„è¯·æ±‚ä½“æ•°æ®
    json_data = request.json

    # ä½ å¯ä»¥è¿›ä¸€æ­¥å¤„ç†è¿™äº›æ•°æ®
    # ...

    return json({"message": "æ”¶åˆ° POST è¯·æ±‚", "json_data": json_data})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªè·¯ç”±å¤„ç†å‡½æ•° `get_data` å’Œ `post_data`ã€‚å®ƒä»¬åˆ†åˆ«ç”¨äºå¤„ç† GET å’Œ POST è¯·æ±‚ã€‚åœ¨è¿™äº›å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `request.args` æ¥è·å– GET è¯·æ±‚çš„æŸ¥è¯¢å‚æ•°ï¼Œä½¿ç”¨äº† `request.json` æ¥è·å– POST è¯·æ±‚çš„ JSON æ•°æ®ã€‚è¿™å±•ç¤ºäº† `request` å¯¹è±¡å¦‚ä½•åœ¨ä¸åŒæƒ…å†µä¸‹è¢«ä½¿ç”¨ã€‚<br>

### `request.json` ç”¨æ³•ç¤ºä¾‹:

```python
import os
from sanic import Sanic, response
from ocr_server import OCRClass
from fetch_pictures_aiohttp import download_image

app = Sanic("OCRService")

# ä»¥å…¨å±€å˜é‡æ–¹å¼å®ä¾‹åŒ–OCRå¯¹è±¡
ocr_instance = OCRClass()

@app.post("/ocr_handler")
async def ocr_handler(request):
    """æ ¹æ®ä¼ å…¥çš„image_urlä¸‹è½½å›¾ç‰‡æ‰§è¡ŒOCR,OCRæ‰§è¡Œå®Œæ¯•å,å°†ç»“æœè¿”å›åŒæ—¶å†™å…¥mysql,ä¹‹ååˆ é™¤ä¸‹è½½çš„å›¾ç‰‡æ–‡ä»¶,é¿å…ç©ºé—´å ç”¨ã€‚
    """
    # å¼‚æ­¥è·å–è¯·æ±‚æ•°æ®
    request_data = await request.json   # ä½¿ç”¨ `request_data = request.json` ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†ç”±äºå‡½æ•°æ˜¯å¼‚æ­¥å‡½æ•°ï¼Œæ›´æ¨èä½¿ç”¨ `await`ã€‚
    """
    ä¼ å…¥çš„æ•°æ®æ ¼å¼å¦‚ä¸‹:
    {
        "image_url": "https://xxxx.com/...png",  # å›¾ç‰‡é“¾æ¥åœ°å€ å¿…å¡«å‚æ•° å­—ç¬¦ä¸²ç±»å‹
        "url_type": "oss"   # å›¾ç‰‡åœ°å€ç±»å‹ å¿…å¡«å‚æ•° å­—ç¬¦ä¸²ç±»å‹,å–å€¼ä¸º "oss" æˆ– "7min_local"
    }
    """
    image_url = request_data.get("image_url")
    url_type = request_data.get("url_type")

    if image_url and url_type:
        # æ ¹æ®å›¾ç‰‡é“¾æ¥ä¸‹è½½å›¾ç‰‡åˆ°æŒ‡å®šè·¯å¾„,å…·ä½“è·¯å¾„å¯ç‚¹å‡»download_imageè·³è½¬æŸ¥çœ‹ã€‚
        # ä¸‹è½½ä¼šæœ‰ç½‘ç»œæ³¢åŠ¨ã€è€—æ—¶é—®é¢˜,é‡‡ç”¨å¼‚æ­¥é¿å…é˜»å¡
        image_save_path = await download_image(image_url)
        if not image_save_path:
            return response.json({"error": "å›¾ç‰‡ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰€è¾“å…¥å›¾ç‰‡é“¾æ¥æ˜¯å¦æœ‰æ•ˆã€‚"})
        # è½¬æ¢æ•°æ®æ ¼å¼,æ ¼å¼å¿…é¡»ç±»ä¼¼ ['/OCR/2024-01-12/23c6b8f9-afe6-4eb8-b196-40235b0e89d5.jpg']ï¼Œå…ƒç´ ä¸ªæ•°åªèƒ½ä¸º1ã€‚
        path_images_list = [image_save_path]
        # è°ƒç”¨OCRå¤„ç†æ–¹æ³•
        ocr_result = ocr_instance.ocr_handler(path_images_list)
        # OCRæ‰§è¡Œç»“æŸååˆ é™¤æ–‡ä»¶,é¿å…ç©ºé—´å ç”¨
        os.remove(image_save_path)
        return response.json(ocr_result)
    else:
        # æç¤ºç”¨æˆ· "image_url" å’Œ "url_type" éƒ½ä¸ºå¿…å¡«å‚æ•°ã€‚
        return response.json({"error": "Invalid request, The 'image_url' and 'url_type' fields are both required parameters."}, status=400)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
```

`request.json` çš„ä¸­çš„é”®å€¼å¯¹å¯ä»¥ä½¿ç”¨`.get("key")`æ–¹æ³•æ¥è·å–ï¼Œä½¿ç”¨`.get("key")`æ–¹æ³•æ¥è·å–å­—å…¸ä¸­çš„å€¼æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œé‚£å°±æ˜¯å¦‚æœé”®ä¸å­˜åœ¨ï¼Œå®ƒä¼šè¿”å›`None`è€Œä¸æ˜¯æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚è¿™å¯ä»¥è®©ä½ çš„ä»£ç æ›´åŠ å¥å£®ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤–éƒ¨ä¼ å…¥çš„æ•°æ®æ—¶ã€‚<br>


## response å¯¹è±¡ï¼š

`from sanic import response` æ˜¯ Sanic æ¡†æ¶æä¾›çš„ä¸€ä¸ªæ¨¡å—ï¼Œå®ƒåŒ…å«äº†ä¸€äº›ç”¨äºæ„å»º HTTP å“åº”çš„å®ç”¨å‡½æ•°ã€‚è¿™ä¸ªæ¨¡å—ä½¿å¾—è¿”å›ä¸åŒç±»å‹çš„å“åº”å˜å¾—æ›´åŠ ç®€å•ã€‚å…¶ä¸­ï¼Œ`response.json` æ˜¯å…¶ä¸­ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„å‡½æ•°ï¼Œå®ƒç”¨äºæ„å»º JSON æ ¼å¼çš„ HTTP å“åº”ã€‚<br>

ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§ç”¨æ³•å’Œç¤ºä¾‹ï¼š<br>

1. è¿”å› JSON å“åº”ï¼š

ä½¿ç”¨ `response.json` å‡½æ•°ï¼Œä½ å¯ä»¥å°† Python å­—å…¸æˆ–å¯¹è±¡è½¬æ¢ä¸º JSON æ ¼å¼çš„å“åº”å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ç¤ºä¾‹ï¼š<br>

```python
from sanic import Sanic
from sanic import response

app = Sanic(__name__)

@app.route("/json")
async def json_example(request):
    data = {"message": "Hello, Sanic!"}
    return response.json(data)
```

è¿™å°†è¿”å›ä¸€ä¸ª JSON å“åº”ï¼Œå…¶å†…å®¹ä¸º `{"message": "Hello, Sanic!"}`ã€‚<br>

2. è¿”å›æ–‡æœ¬å“åº”ï¼š

ä½¿ç”¨ `response.text` å‡½æ•°ï¼Œä½ å¯ä»¥è¿”å›æ™®é€šæ–‡æœ¬å“åº”ã€‚ç¤ºä¾‹ï¼š<br>

```python
@app.route("/text")
async def text_example(request):
    return response.text("This is a text response.")
```

è¿™å°†è¿”å›ä¸€ä¸ªåŒ…å«æŒ‡å®šæ–‡æœ¬çš„å“åº”ã€‚<br>

3. è¿”å› HTML å“åº”ï¼š

ä½¿ç”¨ `response.html` å‡½æ•°ï¼Œä½ å¯ä»¥è¿”å›åŒ…å« HTML å†…å®¹çš„å“åº”ã€‚ç¤ºä¾‹ï¼š<br>

```python
@app.route("/html")
async def html_example(request):
    html_content = "<html><body><h1>Hello, Sanic!</h1></body></html>"
    return response.html(html_content)
```

è¿™å°†è¿”å›ä¸€ä¸ªåŒ…å«æŒ‡å®š HTML å†…å®¹çš„å“åº”ã€‚<br>

æ€»ä¹‹ï¼Œ`response` æ¨¡å—æä¾›äº†ä¸€äº›æ–¹ä¾¿çš„å‡½æ•°ï¼Œç”¨äºæ„å»ºä¸åŒç±»å‹çš„ HTTP å“åº”ï¼ŒåŒ…æ‹¬ JSONã€æ–‡æœ¬ã€HTML ç­‰ã€‚ä½ å¯ä»¥æ ¹æ®ä½ çš„éœ€æ±‚ä½¿ç”¨è¿™äº›å‡½æ•°æ¥æ„å»ºå’Œè¿”å›é€‚å½“ç±»å‹çš„å“åº”ç»™å®¢æˆ·ç«¯ã€‚<br>


## é«˜çº§åŠŸèƒ½:

### åŸºäºç±»çš„è§†å›¾(Class Based Views)ï¼š

#### ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒä»¬(Why use them)ï¼Ÿ

#### é—®é¢˜æ‰€åœ¨(The problem)ï¼š

è®¾è®¡APIæ—¶çš„ä¸€ä¸ªå¸¸è§æ¨¡å¼æ˜¯åœ¨åŒä¸€ä¸ªç«¯ç‚¹ä¸Šæ ¹æ®HTTPæ–¹æ³•å®ç°å¤šç§åŠŸèƒ½ã€‚<br>

å°½ç®¡è¿™ä¸¤ç§é€‰æ‹©éƒ½å¯è¡Œï¼Œä½†å®ƒä»¬å¹¶ä¸æ˜¯å¥½çš„è®¾è®¡å®è·µï¼Œå¹¶ä¸”éšç€é¡¹ç›®çš„å¢é•¿ï¼Œéšç€æ—¶é—´çš„æ¨ç§»å¯èƒ½éš¾ä»¥ç»´æŠ¤ã€‚<br>

```python
@app.get("/foo")
async def foo_get(request):
    ...

@app.post("/foo")
async def foo_post(request):
    ...

@app.put("/foo")
async def foo_put(request):
    ...

@app.route("/bar", methods=["GET", "POST", "PATCH"])
async def bar(request):
    if request.method == "GET":
        ...

    elif request.method == "POST":
        ...

    elif request.method == "PATCH":
        ...
```

#### è§£å†³æ–¹æ¡ˆ(The solution)ï¼š

åŸºäºç±»çš„è§†å›¾ (Class-based views) å®é™…ä¸Šæ˜¯å®ç°å¯¹è¯·æ±‚å“åº”è¡Œä¸ºçš„ç±»ã€‚å®ƒä»¬æä¾›äº†ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥åœ¨åŒä¸€ç«¯ç‚¹ä¸Š **å¯¹ä¸åŒHTTPè¯·æ±‚ç±»å‹è¿›è¡Œåˆ†é—¨åˆ«ç±»çš„å¤„ç†** ã€‚<br>

```python
from sanic.views import HTTPMethodView

class FooBar(HTTPMethodView):
    async def get(self, request):
        ...

    async def post(self, request):
        ...

    async def put(self, request):
        ...

app.add_route(FooBar.as_view(), "/foobar")
```


### Streaming:

#### Response streaming:

Sanic å…è®¸ä½ å‘å®¢æˆ·ç«¯æµå¼ä¼ è¾“å†…å®¹ã€‚<br>

```python
from sanic import Sanic
from sanic.response.types import BaseHTTPResponse   # response.send ä¸­ send æ–¹æ³•å‡ºå¤„ï¼›
from sanic.request import Request

app = Sanic("MyApp")

@app.route("/")
async def test(request: Request):
    response = await request.respond(content_type="text/csv")
    await response.send("foo,")
    await response.send("bar")

    # Optionally, you can explicitly end the stream by calling:
    await response.eof()


if __name__ == '__main__':
    app.run()
```

è¿™åœ¨ä½ æƒ³è¦å°†æ¥è‡ªå¤–éƒ¨æœåŠ¡ï¼ˆå¦‚æ•°æ®åº“ï¼‰çš„å†…å®¹æµå¼ (stream content) ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ã€‚<br>

ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ `asyncpg` æä¾›çš„å¼‚æ­¥æ¸¸æ ‡(asynchronous cursor)å°† **æ•°æ®åº“è®°å½•** æµå¼ä¼ è¾“ç»™å®¢æˆ·ç«¯ã€‚<br>

```python
@app.route("/")
async def index(request):
    response = await request.respond()
    conn = await asyncpg.connect(database='test')
    async with conn.transaction():
        async for record in conn.cursor('SELECT generate_series(0, 10)'):
            await response.send(record[0])
```

ä½ å¯ä»¥é€šè¿‡è°ƒç”¨ `await response.eof()` æ¥æ˜¾å¼(explicitly)ç»“æŸä¸€ä¸ªæµã€‚è¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„æ–¹æ³•(a convenience method)ï¼Œç”¨æ¥æ›¿ä»£ `await response.send("", True)`ã€‚

åœ¨å¤„ç†ç¨‹åºç¡®å®šæ²¡æœ‰æ›´å¤šå†…å®¹éœ€è¦å‘é€å›å®¢æˆ·ç«¯åï¼Œåº”è¯¥è°ƒç”¨å®ƒä¸€æ¬¡ã€‚<br>

ğŸš¨ğŸš¨ğŸš¨è™½ç„¶åœ¨ä½¿ç”¨ Sanic æœåŠ¡å™¨æ—¶å¯ä»¥é€‰æ‹©ä½¿ç”¨å®ƒï¼Œä½†å¦‚æœä½ åœ¨ ASGI æ¨¡å¼ä¸‹è¿è¡Œ Sanicï¼Œé‚£ä¹ˆå¿…é¡»æ˜¾å¼ç»ˆæ­¢æµã€‚<br>

> åœ¨ v21.6 ç‰ˆæœ¬ä¸­ï¼Œè°ƒç”¨ `eof` å˜æˆäº†å¯é€‰æ“ä½œã€‚


## ä½¿ç”¨ Postman åŠ¨æ€æ›´æ–°SanicæœåŠ¡ä¸­ç±»å±æ€§ï¼š

å·¥ä½œä¸­ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°éœ€è¦åœ¨ç¨‹åºå¯åŠ¨ååŠ¨æ€æ›´æ–°æŸäº›å˜é‡çš„æƒ…å†µï¼Œæ¥ä¸‹æ¥æˆ‘å°†ç»™ä½ å…·ä½“çš„ä¾‹å­ï¼š<br>

### åœ¨ä¸»æ–‡ä»¶ä¸­å®šä¹‰è·¯ç”±ï¼š

```python
# main.py
from sanic import Sanic
from sanic import response
from nlp_entry import create_pipelene
from code_utils import Dimension_analy

app = Sanic("my_app")

@app.route("/ans", methods=["POST"])
async def answer(request):
    # è·å–ç”¨æˆ·æ•°æ®
    text = request.form.get("usr_input")
    processed_data = create_pipelene(text)
    return response.json(processed_data)

@app.route("/refresh")
async def refresh_metadata(request):
    Dimension_analy.modify_class_variable()
    return response.json({"message":"Dimension_analyçš„ç±»å±æ€§æ›´æ–°æˆåŠŸ"})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

### é™„å±æ–‡ä»¶ä¸­å®šä¹‰ç”¨æˆ·è¾“å‡ºçš„å¤„ç†æµç¨‹ï¼š

```python
# nlp_entry.py

from code_utils import Dimension_analy

def create_pipelene(usr_input):
    tmp_dimension = Dimension_analy()
    res_dim = tmp_dimension.handle(usr_input)
    return res_dim
```

### å·¥å…·å‹å‡½æ•°ä¸­å®šä¹‰æ–‡æœ¬å¤„ç†ã€å˜é‡æ›´æ–°ç»†èŠ‚ï¼š

```python
# code_utils
class Dimension_analy:
    """è¿›è¡Œç»´åº¦åˆ†æ
    """
    # å®šä¹‰ç±»å±æ€§
    dimension_data = 0

    def __init__(self):
        pass

    def handle(self, usr_input):
        """æµ‹è¯•ç±»å±æ€§æ˜¯å¦å˜åŒ–ï¼Œæ˜¯å¦æ”¯æŒåŠ¨æ€æ›´æ–°
        """
        res_dict = {"ç”¨æˆ·æ•°æ®":usr_input,
                    "ç»´åº¦æ•°æ®ä¸º:": self.dimension_data} # è°ƒç”¨ç±»å±æ€§
        return res_dict

    @classmethod
    def modify_class_variable(cls):
        """æ¯æ¬¡è°ƒç”¨æ›´æ–°ä¸€æ¬¡ç±»å±æ€§
        """
        cls.dimension_data += 1
```

### è¿è¡Œæ–¹å¼ï¼š

1. å¯åŠ¨`main.py`æ–‡ä»¶ï¼›

2. Postmané€‰æ‹©POSTæ–¹æ³•ï¼Œurlè¾“å…¥http://8.140.203.xxx:8848/ansï¼›

3. "Body"çš„"x-www-form-urlencoded"é€‰é¡¹ä¸­è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š

Key|Value|Description
---|---|---
usr_input | é»„é‡‘æ¿å—æ”¶ç›Šå¦‚ä½•ï¼Ÿ | Valueä¸­çš„å†…å®¹å¯ä¸ºä»»æ„å­—ç¬¦ä¸²

4. ç‚¹å‡»Sendï¼Œä½ å°†è·å¾—å¦‚ä¸‹JSONå“åº”ï¼š

```json
{
    "ç”¨æˆ·æ•°æ®": "é»„é‡‘æ¿å—æ”¶ç›Šå¦‚ä½•ï¼Ÿ",
    "ç»´åº¦æ•°æ®ä¸º:": 0
}
```

ç”±äºæ²¡æœ‰æ›´æ–°"Dimension_analy"ä¸­"dimension_data"ï¼Œæ‰€ä»¥æ­¤å¤„æ˜¾ç¤ºçš„æ˜¯åŸå§‹å€¼ "dimension_data = 0"ã€‚<br>

ç°åœ¨ï¼Œæˆ‘ä»¬å°è¯•é€šè¿‡æ¥å£ "/refresh" æ›´æ–° "dimension_data" æµ‹è¯•ä¸‹æ•ˆæœï¼š<br>

5. Postmané€‰æ‹©GETæ–¹æ³•ï¼Œurlè¾“å…¥http://8.140.203.xxx:8848/refreshï¼›(ä¸éœ€è¦è¾“å…¥å…¶ä»–å‚æ•°)

6. ç‚¹å‡»Sendï¼Œä½ å°†è·å¾—å¦‚ä¸‹JSONå“åº”ï¼š

```json
{
    "message": "Dimension_analyçš„ç±»å±æ€§æ›´æ–°æˆåŠŸ"
}
```

7. è½¬å›http://8.140.203.xxx:8848/ansæ¥å£ç•Œé¢ï¼Œç‚¹å‡»Sendï¼Œä½ å°†è·å¾—å¦‚ä¸‹JSONå“åº”ï¼š

```json
{
    "ç”¨æˆ·æ•°æ®": "é»„é‡‘æ¿å—æ”¶ç›Šå¦‚ä½•ï¼Ÿ",
    "ç»´åº¦æ•°æ®ä¸º:": 1
}
```

æ•°æ®åŠ¨æ€æ›´æ–°äº†ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­æ›´æ–°äº†~~~~<br>

8. æˆ‘ä»¬å†æ¬¡è¿è¡Œhttp://8.140.203.xxx:8848/refreshæ¥å£ï¼Œçœ‹ä¸‹"/ans"æ¥å£çš„æ•ˆæœ:

```json
{
    "ç”¨æˆ·æ•°æ®": "é»„é‡‘æ¿å—æ”¶ç›Šå¦‚ä½•ï¼Ÿ",
    "ç»´åº¦æ•°æ®ä¸º:": 2
}
```

æ•°æ®å†æ¬¡æ›´æ–°ï¼ŒåŠ¨æ€æ›´æ–°æ•ˆæœå®ŒæˆğŸª´ğŸª´ğŸª´<br>

ğŸ¥´ğŸ¥´ğŸ¥´æ­¤æ—¶ï¼Œç›´åˆ°ä½ ä¸‹æ¬¡è°ƒç”¨"/refresh"æ¥å£ï¼Œç¨‹åºçš„"Dimension_analy"ä¸­"dimension_data"æ•°æ®å°†ä¿æŒä¸å˜ã€‚<br>

## ä½¿ç”¨Postman+globalåŠ¨æ€æ›´æ–°SanicæœåŠ¡ä¸­çš„æ•°æ®ï¼š

### ä»»åŠ¡ç›®æ ‡ï¼š

1. ç¡®ä¿ç¨‹åºæ­£å¸¸å¯åŠ¨ï¼›
2. å°†æ•°æ®å­˜å…¥ Redis åï¼Œä¸ªäººæ‰§è¡Œä¸€æ¬¡è§£ææ“ä½œï¼Œè·å–å¯¹åº”æ•°æ®ï¼›
3. ç”¨æˆ·æ¯æ¬¡è°ƒç”¨ç¬”è€…çš„æ¥å£ä½¿ç”¨è¯¥æ•°æ®ï¼Œä¸å¿…é‡æ–°ä» Redis è·å–æ•°æ®ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚

### ä¸»æ–‡ä»¶ï¼š

```python
# main.py
from sanic import Sanic
from sanic import response
from code_utils import my_function
import redis
import pickle

app = Sanic("my_app")

# è¿æ¥åˆ°Redis
redis_conn = redis.Redis(host='localhost', port=6379)

# å…¨å±€å˜é‡ç”¨äºå­˜å‚¨metadata
metadata = None

@app.route("/ans", methods=["POST"])
async def answer(request):
    # è·å–ç”¨æˆ·æ•°æ®
    text = request.form.get("usr_input")
    if metadata is not None:
        processed_data = my_function(metadata)
        res_dict = {"ç”¨æˆ·æ•°æ®":text,
                    "redisä¸­æ•°æ®": processed_data}
    else:
        res_dict = {"ç”¨æˆ·æ•°æ®":text,
                    "redisä¸­æ•°æ®": metadata}
    return response.json(res_dict)

@app.route("/refresh")
async def refresh_metadata(request):
    if redis_conn.get('my_data') is not None:
        global metadata
        metadata = pickle.loads(redis_conn.get('my_data'))
        return response.json({"message": "Metadata å·²åˆ·æ–°!"})
    else:
        return response.json({"message": "Metadata è¿˜æœªå†™å…¥redisï¼Œè¯·å…ˆè¿è¡Œ'/data_to_redis'æ¥å£ã€‚"})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

### å·¥å…·æ–‡ä»¶ï¼š

```python
# code_utils.py
def my_function(data):
    for idx, item in enumerate(data,1):
        item["å‡½æ•°æ·»åŠ å†…å®¹"] = f"å†…å®¹{idx}"
    return data
```

### æ•°æ®å­˜å…¥redisçš„æ–‡ä»¶ï¼š

```python
# metadata_to_redis.py
import redis
import pickle

# è¿æ¥åˆ°Redis
redis_conn = redis.Redis(host='localhost', port=6379)

# å¯æ”¹ä¸ºå…¶ä»–æ•°æ®ï¼Œæ­¤å¤„åªæ˜¯ä¸ºäº†æ¨¡æ‹Ÿæ•°æ®å†™å…¥ã€‚
data = [{'info_1':{'name': 'éº¦å…‹', 'age': 30, 'man': 'true'}}, 
        {'info_2':{'name': 'Juddy', 'age': 27, 'man': 'false'}}]

# å°†æ•°æ®å­˜å…¥Redis
redis_conn.set('my_data', pickle.dumps(data))
```

### æ¸…ç©ºRedisæ•°æ®(å¯é€‰)ï¼š

å¦‚æœä½ åœ¨ä»£ç æµ‹è¯•è¿‡ç¨‹ä¸­æƒ³è¦æ¸…ç©ºRedisï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ—ä»£ç ï¼š<br>

```python
# empty_redis.py
import redis

# è¿æ¥åˆ°Redis
redis_conn = redis.Redis(host='localhost', port=6379)
# æ¸…ç©ºredis
redis_conn.flushall()
```

### æ–‡ä»¶è¿è¡Œé¡ºåºï¼š

1. è¿è¡Œ`metadata_to_redis.py`æ–‡ä»¶ï¼›

2. è°ƒç”¨`/refresh`æ¥å£ï¼›

3. ç”¨æˆ·æ­¤æ—¶å°±å¯å‘`ans`æ¥å£ä¼ å‚ï¼Œè·å–æ•°æ®ï¼›

### ä»£ç è§£é‡Šï¼š

è¯¥ä»£ç ä¸ºç”¨æˆ·æä¾›ä¸¤ä¸ªæ¥å£ï¼š"/ans"ã€"/refresh"ï¼Œå’Œä¸€ä¸ªæ•°æ®å†™å…¥Redisçš„æ–‡ä»¶ã€‚<br>

ä»¥ä¸‹æ˜¯æ¯ä¸ªæ¥å£/æ–‡ä»¶çš„ä½œç”¨ï¼š<br>

1. `metadata_to_redis.py`ï¼š å°†æ•°æ®å­˜å…¥Redisã€‚

2. `/refresh`ï¼šä»Redisä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¿å­˜åœ¨å…¨å±€å˜é‡`metadata`ä¸­ã€‚

3. `/ans`ï¼šè¿”å›åŒ…å«ç”¨æˆ·æä¾›æ•°æ®å’Œ`metadata`ä¸­çš„æ•°æ®çš„å“åº”ã€‚åœ¨æ­¤æ¥å£ä¸­ï¼Œå®ƒè¿˜è°ƒç”¨`my_function`æ¥å¤„ç†`metadata`æ•°æ®ã€‚


å½“è¿è¡Œ`metadata_to_redis.py`åï¼Œæ•°æ®è¢«å­˜å…¥Redisã€‚ä¹‹åè¿è¡Œ`/refresh`æ¥å£ï¼Œæ•°æ®ä»Redisä¸­è¯»å–å¹¶å­˜å‚¨åˆ°å…¨å±€å˜é‡`metadata`ä¸­ã€‚æ­¤æ—¶ï¼Œå¯¹äºåç»­çš„`/ans`æ¥å£è°ƒç”¨ï¼Œç¨‹åºç›´æ¥ä»å…¨å±€å˜é‡`metadata`ä¸­è¯»å–æ•°æ®ï¼Œè€Œä¸æ˜¯ä»Redisä¸­ã€‚<br>

ç”¨æˆ·æ¯æ¬¡è°ƒç”¨`ans`æ¥å£ä¸ä¼šå†æœ‰ä»Redisè·å–æ•°æ®å¹¶pickleçš„æ—¶é—´ï¼Œå› ä¸ºæ•°æ®å·²ç»è¢«å­˜å‚¨åœ¨å…¨å±€å˜é‡`metadata`ä¸­ï¼Œæ¥å£ç›´æ¥ä»è¿™ä¸ªå˜é‡è·å–æ•°æ®ã€‚<br>


## å¯åŠ¨SanicæœåŠ¡æ—¶åªåŠ è½½ä¸€æ¬¡æ¨¡å‹--é¿å…æ¯æ¬¡è°ƒç”¨æ¥å£æ—¶åŠ è½½æ¨¡å‹çš„è€—æ—¶:

### æ¨¡æ‹Ÿåœºæ™¯:

æˆ‘ä½¿ç”¨sanicèµ·äº†ä¸€ä¸ªæœåŠ¡ï¼Œ`/classify`æ¥å£ä¸­è°ƒç”¨äº†æˆ‘è‡ªå®šä¹‰çš„ç±»Classify_dataä¸­çš„predictæ–¹æ³•ï¼Œç±»Classify_dataçš„`init`æ–¹æ³•ä¸­åŠ è½½äº†bertæ¨¡å‹ã€‚æˆ‘çš„ä»£ç åº”è¯¥æ€ä¹ˆå†™æ‰èƒ½é¿å…æ¯æ¬¡è°ƒç”¨`/classify`æ¥å£éƒ½è¦åŠ è½½æ¨¡å‹ï¼Ÿ<br>

### è§£å†³æ–¹æ¡ˆ-sanicåº”ç”¨çš„ä¸Šä¸‹æ–‡:

ä¸ºäº†é¿å…æ¯æ¬¡è°ƒç”¨`/classify`æ¥å£éƒ½è¦åŠ è½½BERTæ¨¡å‹ï¼Œä½ å¯ä»¥åœ¨å¯åŠ¨SanicæœåŠ¡æ—¶å°±åŠ è½½æ¨¡å‹ï¼Œå¹¶å°†æ¨¡å‹ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€å˜é‡æˆ–è€…åº”ç”¨çš„ä¸Šä¸‹æ–‡ä¸­ã€‚è¿™æ ·ï¼Œæ¯æ¬¡è°ƒç”¨æ¥å£æ—¶ï¼Œåªéœ€è¦ä»ä¸Šä¸‹æ–‡ä¸­è·å–å·²åŠ è½½çš„æ¨¡å‹å³å¯ã€‚è¿™ç§æ–¹æ³•å¯ä»¥æ˜¾è‘—å‡å°‘æ¥å£çš„å“åº”æ—¶é—´ï¼Œå› ä¸ºåŠ è½½å¤§å‹æ¨¡å‹ï¼ˆå¦‚BERTï¼‰é€šå¸¸éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚<br>

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¾‹å­ï¼Œå±•ç¤ºå¦‚ä½•åœ¨Sanicåº”ç”¨ä¸­å®ç°è¿™ä¸ªç­–ç•¥ï¼š<br>

```python
from sanic import Sanic
from sanic.response import json
from your_model_file import Classify_data  # å‡è®¾è¿™æ˜¯ä½ çš„æ¨¡å‹ç±»

app = Sanic("ModelApp")

# åœ¨å¯åŠ¨åº”ç”¨æ—¶åŠ è½½æ¨¡å‹
@app.listener('before_server_start')
async def load_model(app, loop):
    app.ctx.classify_model = Classify_data()

# ä½¿ç”¨å·²åŠ è½½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹
@app.route('/classify', methods=['POST'])
async def classify(request):
    # è·å–è¯·æ±‚æ•°æ®
    data = request.json
    # ç›´æ¥ä½¿ç”¨å·²åŠ è½½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹
    prediction = app.ctx.classify_model.predict(data)
    return json({"prediction": prediction})

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=8000)
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`Classify_data`çš„å®ä¾‹åŒ–ï¼ˆåŒ…æ‹¬BERTæ¨¡å‹çš„åŠ è½½ï¼‰å‘ç”Ÿåœ¨`before_server_start`äº‹ä»¶å¤„ç†å™¨ä¸­ã€‚è¿™æ„å‘³ç€æ¨¡å‹åªä¼šåœ¨SanicæœåŠ¡å¯åŠ¨æ—¶åŠ è½½ä¸€æ¬¡ã€‚ä¹‹åï¼Œæ¯æ¬¡è°ƒç”¨`/classify`æ¥å£æ—¶ï¼Œé€šè¿‡`app.ctx.classify_model`å³å¯è®¿é—®åˆ°è¿™ä¸ªå·²åŠ è½½çš„æ¨¡å‹å®ä¾‹ï¼Œè€Œæ— éœ€é‡å¤åŠ è½½ã€‚<br>

è¯·æ ¹æ®ä½ çš„å®é™…æƒ…å†µè°ƒæ•´`your_model_file`å’Œ`Classify_data`çš„ç›¸å…³éƒ¨åˆ†ã€‚è¿™ç§æ–¹æ³•é€‚ç”¨äºä»»ä½•éœ€è¦é¿å…é‡å¤åŠ è½½é‡é‡çº§èµ„æºï¼ˆå¦‚æ¨¡å‹æ–‡ä»¶ã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰çš„åœºæ™¯ã€‚<br>

### è§£å†³æ–¹æ¡ˆ-å…¨å±€å˜é‡:

```python
from sanic import Sanic
from sanic.response import json
from your_model_file import Classify_data  # å‡è®¾è¿™æ˜¯ä½ çš„æ¨¡å‹ç±»

app = Sanic("ModelApp")
# å®ä¾‹åŒ–ç±»Classify_data
classify_model = Classify_data()

# ä½¿ç”¨å·²åŠ è½½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹
@app.route('/classify', methods=['POST'])
async def classify(request):
    # è·å–è¯·æ±‚æ•°æ®
    data = request.json
    # ç›´æ¥ä½¿ç”¨å·²åŠ è½½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹
    prediction = classify_model.predict(data)
    return json({"prediction": prediction})

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=8000)
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ åœ¨Sanicåº”ç”¨çš„å…¨å±€ä½œç”¨åŸŸä¸­åˆ›å»ºäº†`Classify_data`çš„å®ä¾‹ã€‚è¿™æ„å‘³ç€ï¼Œå½“ä½ çš„Pythonè„šæœ¬æ‰§è¡Œæ—¶ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºå¯åŠ¨SanicæœåŠ¡å™¨æ—¶ï¼‰ï¼Œ`Classify_data`ä¼šè¢«å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œå¹¶ä¸”è¿™ä¸ªå®ä¾‹ä¼šè¢«ä¿å­˜åœ¨`classify_model`å˜é‡ä¸­ã€‚éšåï¼Œåœ¨æ¯æ¬¡è°ƒç”¨`/classify`æ¥å£æ—¶ï¼Œä½ éƒ½ä¼šä½¿ç”¨è¿™ä¸ªå·²ç»åŠ è½½å¹¶å®ä¾‹åŒ–çš„æ¨¡å‹æ¥è¿›è¡Œé¢„æµ‹ï¼Œè€Œä¸éœ€è¦é‡æ–°åŠ è½½æ¨¡å‹ã€‚<br>

è¿™ç§æ–¹æ³•åŒæ ·æœ‰æ•ˆåœ°é¿å…äº†æ¯æ¬¡è¯·æ±‚éƒ½é‡æ–°åŠ è½½æ¨¡å‹çš„é—®é¢˜ï¼Œå¹¶ä¸”æ˜¯å®ç°è¿™ä¸€ç›®æ ‡çš„å¦ä¸€ç§ç®€æ´æ–¹å¼ã€‚é€‰æ‹©åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®ä¾‹åŒ–æ¨¡å‹ï¼ˆå¦‚ä½ æ‰€ç¤ºä¾‹çš„ä»£ç ï¼‰ï¼Œè¿˜æ˜¯åœ¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸­ä¿å­˜æ¨¡å‹å®ä¾‹ï¼ˆå¦‚ä¹‹å‰çš„ä¾‹å­æ‰€ç¤ºï¼‰ï¼Œä¸»è¦å–å†³äºä½ çš„åå¥½ä»¥åŠåº”ç”¨çš„å…·ä½“éœ€æ±‚ã€‚ä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥è¾¾åˆ°ç›¸åŒçš„ç›®æ ‡ï¼Œå³å‡å°‘ä¸å¿…è¦çš„é‡å¤èµ„æºåŠ è½½ï¼Œä¼˜åŒ–æœåŠ¡çš„å“åº”æ—¶é—´ã€‚<br>


### åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†`app.ctx`å†™æ³•å’Œå…¨å±€å˜é‡å†™æ³•çš„åŒºåˆ«:

åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†`app.ctx`å†™æ³•å’Œå…¨å±€å˜é‡å†™æ³•ä¸»è¦æœ‰ä¸¤ä¸ªåŒºåˆ«ï¼Œå®ƒä»¬åˆ†åˆ«å…³æ¶‰åˆ°Sanicåº”ç”¨çš„ä¸Šä¸‹æ–‡ç®¡ç†å’Œæ¨¡å‹å®ä¾‹åŒ–çš„æ—¶æœºã€‚ä¸‹é¢æ˜¯è¿™ä¸¤ç§æ–¹æ³•çš„å¯¹æ¯”ï¼š<br>

#### åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç† (`app.ctx.classify_model = Classify_data()`):

1. **ä¸Šä¸‹æ–‡ä½œç”¨åŸŸ**ï¼šå°†æ¨¡å‹ä¿å­˜åœ¨`app.ctx`ï¼ˆå³åº”ç”¨çš„ä¸Šä¸‹æ–‡ï¼‰ä¸­ï¼Œè¿™æ„å‘³ç€æ¨¡å‹å®ä¾‹ä¸Sanicåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸç´§å¯†ç›¸å…³ã€‚è¿™ç§æ–¹æ³•æ›´åŠ é¢å‘å¯¹è±¡ï¼Œåˆ©ç”¨äº†Sanicæä¾›çš„åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†åŠŸèƒ½ï¼Œæœ‰åŠ©äºç»´æŠ¤å’Œç»„ç»‡ä»£ç ï¼Œå°¤å…¶æ˜¯åœ¨æ›´å¤§ã€æ›´å¤æ‚çš„åº”ç”¨ä¸­ã€‚
2. **æ¨¡å‹åŠ è½½æ—¶æœº**ï¼šæ¨¡å‹æ˜¯åœ¨`before_server_start`äº‹ä»¶ç›‘å¬å™¨ä¸­è¢«æ˜¾å¼åŠ è½½çš„ã€‚è¿™å…è®¸åœ¨æœåŠ¡å™¨å®Œå…¨å¯åŠ¨å‰æ‰§è¡Œåˆå§‹åŒ–ä»£ç ï¼Œå¦‚åŠ è½½æ¨¡å‹ã€å»ºç«‹æ•°æ®åº“è¿æ¥ç­‰ã€‚è¿™æ ·åšå¯ä»¥ç¡®ä¿åœ¨å¤„ç†ä»»ä½•è¯·æ±‚ä¹‹å‰ï¼Œæ‰€æœ‰çš„åˆå§‹åŒ–å·¥ä½œéƒ½å·²å®Œæˆã€‚

#### å…¨å±€å®ä¾‹åŒ– (`classify_model = Classify_data()`):

1. **å…¨å±€å˜é‡**ï¼šå°†æ¨¡å‹å®ä¾‹åŒ–ä¸ºä¸€ä¸ªå…¨å±€å˜é‡ã€‚è¿™ç§æ–¹æ³•ç®€å•ç›´æ¥ï¼Œå¯¹äºå°å‹åº”ç”¨æˆ–è€…è„šæœ¬æ¥è¯´éå¸¸æ–¹ä¾¿å’Œè¶³å¤Ÿç”¨ã€‚å®ƒç›´è§‚åœ°æ˜¾ç¤ºäº†æ¨¡å‹æ˜¯å¦‚ä½•å’Œä½•æ—¶è¢«åŠ è½½çš„ï¼Œä½¿å¾—ä»£ç æ˜“äºç†è§£ã€‚
2. **æ¨¡å‹åŠ è½½æ—¶æœº**ï¼šæ¨¡å‹åœ¨è„šæœ¬æ‰§è¡ŒæœŸé—´ï¼ˆåŒ…æ‹¬æœåŠ¡å™¨å¯åŠ¨å‰ï¼‰å°±è¢«åŠ è½½äº†ã€‚è¿™æ„å‘³ç€ï¼Œä¸€æ—¦å¼€å§‹æ‰§è¡Œè„šæœ¬ï¼Œæ— è®ºæœåŠ¡å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥å—è¯·æ±‚ï¼Œæ¨¡å‹åŠ è½½çš„å·¥ä½œå°±å·²ç»å¼€å§‹ã€‚è¿™å¯¹äºå¯åŠ¨æ—¶é—´ä¸æ•æ„Ÿçš„åº”ç”¨æ˜¯å¯è¡Œçš„ã€‚

#### é€‰æ‹©ä¾æ®:

- **åº”ç”¨è§„æ¨¡**ï¼šå¯¹äºè¾ƒå¤§ã€ç»“æ„å¤æ‚çš„åº”ç”¨ï¼Œæ¨èä½¿ç”¨åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†æ–¹å¼ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºæ›´å¥½åœ°ç»„ç»‡ä»£ç å’Œç®¡ç†èµ„æºã€‚è€Œå¯¹äºç®€å•çš„åº”ç”¨æˆ–è„šæœ¬ï¼Œå…¨å±€å®ä¾‹åŒ–æ–¹å¼å¯èƒ½æ›´ç›´æ¥å’Œç®€ä¾¿ã€‚
- **ä»£ç ç»„ç»‡**ï¼šä½¿ç”¨`app.ctx`å¯ä»¥è®©èµ„æºå’Œé…ç½®ä¸ç‰¹å®šçš„Sanicåº”ç”¨å®ä¾‹å…³è”ï¼Œè¿™åœ¨å¤„ç†å¤šä¸ªSanicå®ä¾‹æˆ–åœ¨å·¥å‚å‡½æ•°ä¸­åˆ›å»ºSanicåº”ç”¨æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚
- **åˆå§‹åŒ–æ—¶æœº**ï¼šå¦‚æœä½ çš„æ¨¡å‹åŠ è½½æˆ–å…¶ä»–åˆå§‹åŒ–æ“ä½œéœ€è¦å¼‚æ­¥æ‰§è¡Œï¼Œæˆ–è€…éœ€è¦åœ¨æœåŠ¡å™¨å®Œå…¨å¯åŠ¨å‰å®Œæˆç‰¹å®šçš„å‡†å¤‡å·¥ä½œï¼Œä½¿ç”¨`before_server_start`ç›‘å¬å™¨ä¼šæ›´é€‚åˆã€‚

æ€»çš„æ¥è¯´ï¼Œä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥å®ç°é¿å…é‡å¤åŠ è½½æ¨¡å‹çš„ç›®æ ‡ï¼Œé€‰æ‹©å“ªä¸€ç§ä¸»è¦å–å†³äºä½ çš„å…·ä½“éœ€æ±‚å’Œåå¥½ã€‚<br>


## Sanic Blueprint:

é€šå¸¸ï¼Œæˆ‘ä»¬åˆ›å»ºçš„SanicæœåŠ¡ä»£ç å¦‚ä¸‹ï¼š<br>

```python
from sanic import Sanic
from sanic import response
import jieba

app = Sanic(__name__)

@app.route("/ans", methods=["POST"])
async def answer(request):
    # è·å–ç”¨æˆ·æ•°æ®
    text = request.form.get("usr_input")
    if not text:
        return response.json({"error": "Missing 'usr_input' parameter"}, status=400)

    result = jieba.lcut(text)
    return response.json({"ç”¨æˆ·æ•°æ®åˆ†è¯ç»“æœä¸ºï¼š": result})

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

ä½†åœ¨è·¯ç”±å‘½åè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‡ºç°å¤šä¸ªç›®å½•ä¸‹å‘½åé‡å¤çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼š<br>

```log
.
â”œâ”€â”€ è€å…‹
â”‚   â”œâ”€â”€ ç”·è£…
â”‚   â””â”€â”€ å¥³è£…
â””â”€â”€ é˜¿è¿ªè¾¾æ–¯
    â””â”€â”€ ç”·è£…
    â””â”€â”€ å¥³è£…
```

æ­¤æ—¶ï¼Œæˆ‘ä»¬ä¸ºäº†åŒºåˆ†"è€å…‹"å’Œ"é˜¿è¿ªè¾¾æ–¯"æ——ä¸‹çš„"ç”·è£…"å’Œ"å¥³è£…"ï¼Œéœ€è¦å¯¹å‘½åç©ºé—´è¿›è¡Œéš”ç¦»ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ<br>

ğŸ« ğŸ« ğŸ« æ­£ç¡®ç­”æ¡ˆæ˜¯ä½¿ç”¨Sanicæä¾›çš„è“å›¾(Blueprint)åŠŸèƒ½ï¼Œ**è“å›¾(Blueprint)ä¸­çš„ `url_prefix` å‚æ•°è¡¨ç¤ºè¯¥è“å›¾çš„å…¬å…±å‰ç¼€**ğŸ³ğŸ³ğŸ³ï¼Œä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ Sanic Blueprint åŠŸèƒ½çš„ä¸€äº›å…³é”®æ¦‚å¿µå’Œæ­¥éª¤ï¼šï¼š<br>

1. å¯¼å…¥ Sanic ã€response å’Œ Blueprintï¼š

```python
from sanic import Sanic
from sanic import response
from sanic import Blueprint
import jieba    # è‡ªå·±æ ¹æ®æƒ…å†µåˆ¤æ–­æ˜¯å¦å¯¼å…¥jieba
```

2. åˆ›å»ºä¸€ä¸ª Sanic åº”ç”¨ç¨‹åºå’Œä¸€ä¸ªæˆ–å¤šä¸ª Blueprintï¼š

å¦‚æœä½ åˆ›å»ºä¸€ä¸ª Blueprintï¼Œå¯ä»¥å‚è€ƒä¸‹åˆ—å†™æ³•ï¼š<br>

```python
app = Sanic(__name__)
# å®šä¹‰è“å›¾
bp = Blueprint('my_blueprint', url_prefix='/my_blueprint')
```

å¦‚æœä½ åˆ›å»ºå¤šä¸ª Blueprintï¼Œå¯ä»¥å‚è€ƒä¸‹åˆ—å†™æ³•ï¼š<br>

```python
app = Sanic(__name__)
# å®šä¹‰è“å›¾
bp1 = Blueprint('my_blueprint1', url_prefix='/my_blueprint1')
bp2 = Blueprint('my_blueprint2', url_prefix='/my_blueprint2')  
```

3. åœ¨å¯¹åº”çš„ Blueprint ä¸­å®šä¹‰è·¯ç”±å’Œè§†å›¾å‡½æ•°ï¼š

> `async def index()`éƒ¨åˆ†è¢«ç§°ä¸ºè§†å›¾å‡½æ•°ã€‚
> å°†`@app.route`æ›¿æ¢ä¸º`@bp.route`ã€‚

```python
@bp.route("/ans", methods=["POST"])
async def answer(request):
    # è·å–ç”¨æˆ·æ•°æ®
    text = request.form.get("usr_input")
    if not text:
        return response.json({"error": "Missing 'usr_input' parameter"}, status=400)

    result = jieba.lcut(text)
    return response.json({"ç”¨æˆ·æ•°æ®åˆ†è¯ç»“æœä¸ºï¼š": result})
```

4. å°† Blueprint æ³¨å†Œåˆ°åº”ç”¨ç¨‹åºä¸­ï¼š

å¦‚æœä½ åˆ›å»ºä¸€ä¸ª Blueprintï¼Œå¯ä»¥å‚è€ƒä¸‹åˆ—å†™æ³•ï¼š<br>

```python
# å°†è“å›¾æ³¨å†Œåˆ°åº”ç”¨ç¨‹åº
app.blueprint(bp)
```

å¦‚æœä½ åˆ›å»ºå¤šä¸ª Blueprintï¼Œå¯ä»¥å‚è€ƒä¸‹åˆ—å†™æ³•ï¼š<br>

```python
# å°†è“å›¾æ³¨å†Œåˆ°åº”ç”¨ç¨‹åº
app.blueprint(bp1)
app.blueprint(bp2)
```

5. æ·»åŠ è¿è¡Œè„šæœ¬ï¼š

```python
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

å‰é¢ï¼Œæˆ‘ä»¬è®²è¿‡ï¼Œ**å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸æ·»åŠ è“å›¾**ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡"http://8.140.203.xxx:8848/ans/"è®¿é—®æˆ‘ä»¬çš„æœåŠ¡ã€‚ç°åœ¨æˆ‘ä»¬æ·»åŠ äº†è“å›¾ï¼Œåªéœ€è¦åœ¨urlçš„ç«¯å£åæ·»åŠ url_prefixçš„éƒ¨åˆ†å³å¯ï¼Œä¾‹å¦‚ï¼š<br>

```log
http://8.140.203.xxx:8848/my_blueprint/ans/
```

ğŸ¤­ğŸ¤­ğŸ¤­ä¸å¿…æ‹…å¿ƒurlçš„éƒ¨åˆ†é‡å¤ï¼Œå› ä¸ºå‰ç¼€ä¸ä¸€æ ·ï¼Œæ‰€ä»¥å¯¹åº”çš„ç½‘å€ä¹Ÿä¸ä¸€æ ·ã€‚<br>

```log
http://8.140.203.xxx:8848/my_blueprint1/ans/
http://8.140.203.xxx:8848/my_blueprint2/ans/
```


ä½¿ç”¨ Blueprint çš„ä¸»è¦å¥½å¤„æ˜¯ï¼Œå®ƒå…è®¸ä½ å°†åº”ç”¨ç¨‹åºæ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±çš„è·¯ç”±å’Œè§†å›¾å‡½æ•°ï¼Œè¿™æœ‰åŠ©äºæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚ä½ å¯ä»¥åˆ›å»ºå¤šä¸ª Blueprintï¼Œå¹¶æ ¹æ®éœ€è¦å°†å®ƒä»¬æ³¨å†Œåˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œè½»æ¾åœ°ç®¡ç†å¤§å‹åº”ç”¨ç¨‹åºçš„è·¯ç”±å’Œè§†å›¾ã€‚<br>

### å®Œæ•´ä»£ç --å•ä¸ªè“å›¾ï¼š

```python
from sanic import Sanic
from sanic import response
from sanic import Blueprint
import jieba    # è‡ªå·±æ ¹æ®æƒ…å†µåˆ¤æ–­æ˜¯å¦å¯¼å…¥jieba

app = Sanic(__name__)
# å®šä¹‰è“å›¾
bp = Blueprint('my_blueprint', url_prefix='/my_blueprint')

@bp.route("/ans", methods=["POST"])
async def answer(request):
    # è·å–ç”¨æˆ·æ•°æ®
    text = request.form.get("usr_input")
    if not text:
        return response.json({"error": "Missing 'usr_input' parameter"}, status=400)

    result = jieba.lcut(text)
    return response.json({"ç”¨æˆ·æ•°æ®åˆ†è¯ç»“æœä¸ºï¼š": result})

# å°†è“å›¾æ³¨å†Œåˆ°åº”ç”¨ç¨‹åº
app.blueprint(bp)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

### å®Œæ•´ä»£ç --å¤šä¸ªè“å›¾ï¼š

å‡è®¾ä½ åˆ›å»ºäº†ä¸¤ä¸ªè“å›¾ï¼Œä½ æƒ³è®©ä¸¤ä¸ªè“å›¾éƒ½è°ƒç”¨"/ans"æ¥å£ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä»£ç ç¤ºä¾‹ï¼š<br>

```python
from sanic import Sanic
from sanic import response
from sanic import Blueprint
import jieba    # è‡ªå·±æ ¹æ®æƒ…å†µåˆ¤æ–­æ˜¯å¦å¯¼å…¥jieba

app = Sanic(__name__)
# å®šä¹‰ç¬¬ä¸€ä¸ªè“å›¾
bp1 = Blueprint('my_blueprint1', url_prefix='/my_blueprint1')

@bp1.route("/ans", methods=["POST"])
async def answer1(request):
    # è·å–ç”¨æˆ·æ•°æ®
    text = request.form.get("usr_input")
    if not text:
        return response.json({"error": "Missing 'usr_input' parameter"}, status=400)

    result = jieba.lcut(text)
    return response.json({"answer1æ¥å£ä¸‹ï¼Œç”¨æˆ·æ•°æ®åˆ†è¯ç»“æœä¸ºï¼š": result})

# å®šä¹‰ç¬¬äºŒä¸ªè“å›¾
bp2 = Blueprint('my_blueprint2', url_prefix='/my_blueprint2')

@bp2.route("/ans", methods=["POST"])
async def answer2(request):
    # è·å–ç”¨æˆ·æ•°æ®
    text = request.form.get("usr_input")
    if not text:
        return response.json({"error": "Missing 'usr_input' parameter"}, status=400)

    # åœ¨ç¬¬äºŒä¸ªè“å›¾ä¸­å¤„ç†ä¸"/ans"æ¥å£ç›¸åŒçš„é€»è¾‘
    result = jieba.lcut(text)
    return response.json({"answer2æ¥å£ä¸‹ï¼Œç”¨æˆ·æ•°æ®åˆ†è¯ç»“æœä¸ºï¼š": result})

# å°†ä¸¤ä¸ªè“å›¾éƒ½æ³¨å†Œåˆ°åº”ç”¨ç¨‹åº
app.blueprint(bp1)
app.blueprint(bp2)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

ç°åœ¨ï¼Œä½ çš„åº”ç”¨ç¨‹åºå°†åŒæ—¶æ”¯æŒä¸¤ä¸ªè“å›¾çš„"/ans"æ¥å£ï¼Œåˆ†åˆ«ç”±`answer1`å’Œ`answer2`å¤„ç†ã€‚è¿™ä¸¤ä¸ªè“å›¾å¯ä»¥åˆ†åˆ«åœ¨ä¸åŒçš„URLå‰ç¼€ä¸‹è®¿é—®ã€‚<br>

ğŸš¨ğŸš¨ğŸš¨æ³¨æ„ï¼šè™½ç„¶ä¸¤ä¸ªè“å›¾"/ans"æ¥å£çš„å¤„ç†ç›¸åŒï¼Œä½†ç”±äºæˆ‘ä»¬å®šä¹‰çš„æ˜¯2ä¸ªè§†å›¾å‡½æ•°ï¼Œä¸èƒ½éƒ½ä½¿ç”¨`async def answer(request)`å†™æ³•ï¼Œè¦è¿›è¡ŒåŒºåˆ†ã€‚<br>


## ä½¿ç”¨Sanicå®ç°Server Sent Event(SSE):

ä½¿ç”¨sanicå®ç°SSEä¼ è¾“ï¼ŒæœåŠ¡å™¨æ‰€è¿”å›çš„å“åº”å†…å®¹éœ€ç¬¦åˆ SSE æ ¼å¼è§„èŒƒï¼š<br>

- å°†æ¶ˆæ¯å†…å®¹æ”¾åœ¨ `data:` ä¹‹åï¼›
- åœ¨æ¯æ¡æ¶ˆæ¯ç»“å°¾ä½¿ç”¨ 2 ä¸ªæ¢è¡Œç¬¦(`\n\n`)ï¼Œå³æ¯æ¡æ¶ˆæ¯ä¹‹é—´ç©ºä¸€è¡Œï¼›

ä¸‹é¢ä»¥Sanicå®˜æ–¹ç»™å‡ºçš„ä»£ç ç¤ºä¾‹è¿›è¡Œç¤ºèŒƒï¼Œåœ¨åŒä¸€ç›®å½•ä¸‹åˆ›å»º`index.html`ã€`server.py`æ–‡ä»¶ï¼Œç„¶åå°†ä¸‹åˆ—ä»£ç åˆ†åˆ«ç²˜è´´åˆ°æ–‡ä»¶å†…ã€‚<br>

ç»ˆç«¯è¿è¡Œä»¥ä¸‹æŒ‡ä»¤:<br>

```bash
python server.py
```

æ‰“å¼€ `http://8.140.203.xxx:8848/` å³å¯çœ‹åˆ°æ•ˆæœã€‚<br>

### `index.html`æ–‡ä»¶ä»£ç å¦‚ä¸‹:

```html
<!DOCTYPE html>
<script>
    let eventSource
    let in_focus = true
    let should_run = false

    window.onblur = function () {
        in_focus = false
    }
    window.onfocus = function () {
        in_focus = true
        if (should_run) {
            start()
        }
    }

    function start() {
        should_run = true
        if (!window.EventSource) {
            // IE or an old browser
            alert("The browser doesn't support EventSource.")
            return
        }

        eventSource = new EventSource('/sse')

        eventSource.onopen = function (e) {
            log("Event: open")
        }

        eventSource.onerror = function (e) {
            log("Event: error")
            if (this.readyState == EventSource.CONNECTING) {
                log(`Reconnecting (readyState=${this.readyState})...`)
            } else {
                log("Error has occured.")
            }
        }

        eventSource.addEventListener('bye', function (e) {
            log("Event: bye, data: " + e.data)
            if (e.data == "close") {
                eventSource.close()
            }
        })

        eventSource.addEventListener('first_only', function (e) {
            log("Event: first_only, data: " + e.data)
        })

        eventSource.onmessage = function (e) {
            log("Event: message, data: " + e.data)
            if (!in_focus) {
                do_stop()
            }
        }
    }

    function stop(manual) {
        should_run = false
        do_stop()
    }

    function do_stop() {
        eventSource.close()
        log("eventSource.close()")
    }

    function log(msg) {
        console.log(msg)
        logElem.innerHTML += msg + "<br>"
        document.documentElement.scrollTop = 99999999
    }

    function reset() {
        document.querySelector("#logElem").innerHTML = ""
    }
</script>
<button onclick="start()">Start</button>
<button onclick="stop()">Stop</button>
<button onclick="reset()">Clear</button>
<pre id="logElem" style="margin: 6px 0"></pre>
```

### `server.py`æ–‡ä»¶ä»£ç å¦‚ä¸‹:

```python
import asyncio
from itertools import count

from sanic import Sanic
from sanic.request import Request
from sanic.response import redirect

c = count()
app = Sanic("__BASE__")
asyncio.set_event_loop_policy(None)


@app.get("/sse")
async def sse(request: Request):
    print("Incoming SSE")
    headers = {"Cache-Control": "no-cache"}
    response = await request.respond(
        headers=headers, content_type="text/event-stream"
    )

    await response.send("event: first_only\n")
    while True:
        i = next(c)
        await response.send(f"data: {i}\n\n")
        await asyncio.sleep(1)

        if i and i % 4 == 0:
            await response.send("event: bye\n")
            await response.send("data: close\n\n")
            break

        await response.send("event: message\n")
    print("Done")


app.static("/index.html", "./index.html")


@app.route("/")
def index(request):
    return redirect("/index.html")

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

### POSTæ–¹å¼è¿›è¡ŒSSEä¼ è¾“:

```python
import asyncio
from sanic import Sanic
from sanic.request import Request

app = Sanic("MyApp")

@app.route("/ans", methods=["POST"])
async def test(request: Request):
    user_input = request.form.get("user_input")
    response = await request.respond(content_type="text/event-stream")
    await response.send(f"data: {user_input}\n\n")  # æµ‹è¯•postä¼ è¾“çš„å€¼
    await asyncio.sleep(1)
    await response.send("data: æ‚¨\n\n")
    await asyncio.sleep(1)
    await response.send("data: å¥½ï¼Œæœ‰\n\n")
    await asyncio.sleep(1)
    await response.send("data: ä»€ä¹ˆ\n\n")
    await asyncio.sleep(1)
    await response.send("data: å¯\n\n")
    await asyncio.sleep(1)
    await response.send("data: ä»¥ä¸ºæ‚¨\n\n")
    await asyncio.sleep(1)
    await response.send("data: æ•ˆåŠ³çš„\n\n")
    await asyncio.sleep(1)
    await response.send("data: å‘¢ï¼Ÿ\n\n")
    await asyncio.sleep(1)
    print("Done")   # ç»ˆç«¯è¾“å‡ºï¼Œä¸ä¼šè¿”å›ç»™å‰ç«¯æˆ–postman

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```

è¿è¡Œä»¥ä¸Šä»£ç åï¼ŒPostmanæµ‹è¯•æ•ˆæœä¸º:<br>

![](./sanic_sse.gif)


### ç»“åˆLLM APIçš„SSEç¤ºä¾‹:

åˆ›å»ºä¸€ä¸ª`.env.local`æ–‡ä»¶ï¼Œç„¶ååœ¨å…¶ä¸­å†™å…¥è‡ªå·±çš„ "OPENAI_API_KEY" å³å¯ä½¿ç”¨ä¸‹åˆ—ä»£ç ã€‚å‡è®¾ä½ åˆ›å»ºäº†ä¸€ä¸ªåä¸º `sanic_sse_example.py` æ–‡ä»¶ï¼Œå°†ä¸‹åˆ—ä»£ç ç²˜è´´å…¶ä¸­ï¼Œç»ˆç«¯è¿è¡Œä¸‹åˆ—æŒ‡ä»¤å³å¯ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•:<br>

```bash
python sanic_see_example.py
```

`sanic_see_example.py`:<br>

```python
import os
import json
from sanic import Sanic
from loguru import logger
from dotenv import load_dotenv
from openai import AsyncOpenAI

app = Sanic("my_app")

# åŠ è½½ç¯å¢ƒå˜é‡
dotenv_path = '.env.local'
load_dotenv(dotenv_path=dotenv_path)

# è®¾ç½®æ—¥å¿—
logger.remove()
logger.add("openai_stream.log", rotation="1 GB", backtrace=True, diagnose=True, format="{time} {level} {message}")


async def get_openai_response(response, chat_history):
    """
    Args:
        response:Sanic response object.
    """
    async with AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY")) as client:
        completion = await client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=chat_history,
            stream=True
        )
        async for chunk in completion:
            if chunk.choices[0].delta.content is not None:
                await response.send(f"data:{chunk.choices[0].delta.content}\n\n")   # æ ‡å‡†sseå“åº”éœ€è¦çš„æ ¼å¼ï¼Œé€‚ç”¨äºpostmanæµ‹è¯•

@app.route("/ans", methods=["POST"])
async def answer(request):
    # fetch user's input.
    user_input = request.form.get("user_input")
    # fetch user's historical chat data.
    chat_history = request.form.get("chat_history") # string,such as '[]'
    response = await request.respond(content_type="text/event-stream")
    try:
        if not user_input:
            logger.warning("ç”¨æˆ·è¾“å…¥ä¸ºç©º")
            raise ValueError("ç”¨æˆ·è¾“å…¥ä¸ºç©º")

        # å› ä¸ºä¼ å…¥çš„æ˜¯jsonæ•°æ®ï¼Œéœ€è¦è§£ç 
        chat_history = json.loads(chat_history)
        logger.info(f"å½“å‰å¯¹è¯å†å²ä¸º:\n{chat_history}\n æ•°æ®ç±»å‹ä¸º:{type(chat_history)}")

        user_history = []   # å­˜å‚¨ç”¨æˆ·èŠå¤©ä¿¡æ¯
        # å¦‚æœå†å²èŠå¤©æ•°æ®ä¸ä¸ºç©º
        if chat_history:
            for user_message, bot_message in chat_history:
                user_history.append({"role": "user", "content": user_message})
                user_history.append({"role": "assistant", "content": bot_message})
        # å‰ä¸€æ­¥æ„æˆçš„user_historyæ˜¯å¶æ•°ï¼Œè¿™é‡Œéœ€è¦åŠ ä¸Šå½“å‰è¾“å…¥ï¼Œæ„æˆå¥‡æ•°çš„content
        user_history.append({"role": "user", "content": user_input})

        # è°ƒç”¨èŠå¤©API
        await get_openai_response(response, user_history)

    except Exception as e:
        logger.error(f"å¤„ç†èŠå¤©è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}")
        raise f"å¤„ç†èŠå¤©è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}"

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8848)
```


## åˆ©ç”¨Chromeæµè§ˆå™¨ä»¥éåŸŸåçš„å½¢å¼è§£é™¤é™åˆ¶è®¿é—®è‡ªå·±çš„æœåŠ¡:

å·¥ä½œä¸­ä½ å¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹æƒ…å†µ:<br>

æœ¬åœ°/æœåŠ¡å™¨å¯åŠ¨äº†ä¸€ä¸ªæœåŠ¡ï¼Œä»¥`http://ip:port`çš„æ–¹å¼è®¿é—®ç½‘é¡µï¼Œç½‘å€çš„æ ‡ç­¾æ˜¾ç¤º **"ä¸å®‰å…¨"** ï¼Œç‚¹å‡» **"ä¸å®‰å…¨"** åå‘ç° éº¦å…‹é£ç­‰åŠŸèƒ½å‡æ— æ³•ä½¿ç”¨ã€‚<br>

è§£å†³æ–¹æ¡ˆ:<br>

### æ–¹æ¡ˆä¸€: ä¸ºè‡ªå·±æœåŠ¡æ³¨å†Œ/ç»‘å®šä¸€ä¸ªåŸŸåã€‚

ä¼˜ç‚¹: é€‚ç”¨èŒƒå›´å¹¿ã€‚<br>

ç¼ºç‚¹: æ“ä½œæ­¥éª¤å¤šï¼Œéœ€è¦æ³¨å†ŒåŸŸåï¼Œéœ€è¦åšNginxåå‘ä»£ç†ã€‚<br>

### æ–¹æ¡ˆäºŒ: æ›´æ”¹Chromeè¯•éªŒæ¨¡å¼é…ç½®ã€‚

1. chromeæµè§ˆå™¨ç½‘å€æ è¾“å…¥:

```txt
chrome://flags/#unsafely-treat-insecure-origin-as-secure
```

2. åœ¨æ‰“å¼€çš„ç½‘é¡µä¸­æœç´¢:

```txt
Insecure origins treated as secure
```

3. åœ¨ "Insecure origins treated as secure" é€‰é¡¹çš„æœç´¢æ¡†è¾“å…¥è‡ªå·±æœåŠ¡çš„ç½‘å€ï¼Œä¾‹å¦‚:

```txt
http://8.140.203.xxx:8082,http://8.140.203.xxx:11167
```

æ³¨æ„:<br>

- å¤šä¸ªç½‘å€ä¹‹é—´ä½¿ç”¨è‹±æ–‡é€—å·(`,`)é—´éš”ã€‚
- "Insecure origins treated as secure"çš„çŠ¶æ€éœ€è¦ä¸º"Enabled"ã€‚

4. ç‚¹å‡»å³ä¸‹è§’çš„"Relauch"ï¼Œåº”ç”¨æ›´æ”¹ã€‚

å½“å‰ç•Œé¢æœ‰ä¿®æ”¹æ—¶ï¼Œä¸‹æ–¹æ ä¼šè‡ªåŠ¨å¼¹å‡º"Relauch"é€‰é¡¹ã€‚ç‚¹å‡»å³ä¸‹è§’çš„"Relauch"åï¼Œchromeä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨æ‰“å¼€ç½‘é¡µã€‚<br>
